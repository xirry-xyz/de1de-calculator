<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾·å·æ‰‘å…‹ç‰Œå±€è¿½è¸ªä¸ç§¯åˆ†æ¦œ</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .btn-primary {
            background-color: #238636;
            transition: background-color 0.2s;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #2ea043;
        }
        .input-field:disabled {
            background-color: #21262d;
            cursor: not-allowed;
        }
        .input-field {
            background-color: #0d1117;
            border-color: #30363d;
            color: #c9d1d9;
        }
        .table-header {
            background-color: #21262d;
            color: #f0f6fc;
        }
        .text-win { color: #2ea043; }
        .text-loss { color: #f85149; }
        .text-neutral { color: #c9d1d9; }
    </style>
</head>
<body>

    <div class="min-h-screen p-4 sm:p-8">
        <h1 class="text-3xl font-bold mb-8 text-center text-white">ğŸ´ å¾·å·æ‰‘å…‹ç»“ç®—ä¸ç§¯åˆ†æ¦œ ğŸ“ˆ</h1>
        
        <!-- Auth Status & Button -->
        <div class="card p-4 rounded-xl mb-6 flex justify-between items-center bg-gray-800/50">
            <div>
                <p id="auth-status" class="text-sm text-yellow-400 font-medium">æ­£åœ¨è¿æ¥ Firebase å¹¶æ£€æŸ¥ç™»å½•çŠ¶æ€...</p>
                <p id="admin-status" class="text-xs mt-1 font-bold"></p>
            </div>
            <button id="auth-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg text-sm" disabled>
                åŠ è½½ä¸­...
            </button>
        </div>

        <!-- Configuration and New Session -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Configuration Card -->
            <div class="card p-6 rounded-xl col-span-1">
                <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">é…ç½®ä¿¡æ¯</h2>
                <div class="space-y-3">
                    <div>
                        <label for="chipsPerEntry" class="block text-sm font-medium mb-1">æ¯æ‰‹ä¹°å…¥ç­¹ç æ•°</label>
                        <input type="number" id="chipsPerEntry" value="3000" class="input-field w-full p-2 rounded-lg border focus:ring-green-500 focus:border-green-500" placeholder="ä¾‹å¦‚: 3000" disabled>
                    </div>
                    <div>
                        <label for="cnyPerEntry" class="block text-sm font-medium mb-1">æ¯æ‰‹ä¹°å…¥å¯¹åº” CNY</label>
                        <input type="number" id="cnyPerEntry" value="300" class="input-field w-full p-2 rounded-lg border focus:ring-green-500 focus:border-green-500" placeholder="ä¾‹å¦‚: 300" disabled>
                    </div>
                    <button onclick="updateConfig()" id="update-config-btn" class="btn-primary w-full p-3 rounded-lg font-semibold mt-4 disabled:opacity-50 disabled:cursor-not-allowed" disabled>æ›´æ–°é…ç½®</button>
                    <p id="config-status" class="text-xs text-green-400 mt-2">æ­£åœ¨ç­‰å¾…æ•°æ®åº“è¿æ¥...</p>
                </div>
            </div>

            <!-- New Player Input Card -->
            <div class="card p-6 rounded-xl col-span-2">
                <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">æ–°å¢ç‰Œå±€ç©å®¶æ•°æ®</h2>
                <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                    <div>
                        <label for="playerName" class="block text-sm font-medium mb-1">ç©å®¶å§“å</label>
                        <input type="text" id="playerName" class="input-field w-full p-2 rounded-lg border" placeholder="A, B, C, D..." disabled>
                    </div>
                    <div>
                        <label for="playerEntries" class="block text-sm font-medium mb-1">å‡€ä¹°å…¥æ¬¡æ•° (å¯ä¸ºè´Ÿ)</label>
                        <input type="number" id="playerEntries" value="2" class="input-field w-full p-2 rounded-lg border" placeholder="ä¾‹å¦‚: 2 æˆ– -1" disabled>
                    </div>
                    <div>
                        <label for="playerFinalChips" class="block text-sm font-medium mb-1">æœ€ç»ˆç­¹ç æ•°</label>
                        <input type="number" id="playerFinalChips" value="3000" class="input-field w-full p-2 rounded-lg border" placeholder="ä¾‹å¦‚: 3000" disabled>
                    </div>
                    <div class="flex items-end">
                        <button onclick="addPlayerToSession()" id="add-player-btn" class="btn-primary w-full p-2 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed" disabled>æ·»åŠ ç©å®¶</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Results and Transfers -->
        <div class="card p-6 rounded-xl mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">å½“å‰ç‰Œå±€ç»“ç®—</h2>
            
            <!-- Player Data Table -->
            <div class="overflow-x-auto mb-6">
                <table class="min-w-full divide-y divide-gray-700 rounded-lg overflow-hidden">
                    <thead class="table-header">
                        <tr>
                            <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">ç©å®¶</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">æ€»ä¹°å…¥ (ç­¹ç )</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">æœ€ç»ˆç­¹ç </th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">P&L (ç­¹ç )</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">P&L (CNY)</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">è°ƒæ•´å P&L</th>
                            <th class="p-3 text-center text-xs font-medium uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="session-data-body" class="divide-y divide-gray-800">
                        <tr id="session-placeholder"><td colspan="7" class="p-4 text-center text-gray-400">è¯·æ·»åŠ ç©å®¶æ•°æ®...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Summary and Actions -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mt-4 p-4 rounded-lg bg-gray-800/50">
                <div class="text-sm">
                    <p>æ€»ä¹°å…¥ç­¹ç : <span id="total-buy-in" class="font-bold">0</span></p>
                    <p>æ€»å‰©ä½™ç­¹ç : <span id="total-final-chips" class="font-bold">0</span></p>
                    <p>ç­¹ç å·®é¢ (åº”ä¸º0): <span id="chip-discrepancy" class="font-bold">0</span></p>
                    <p>CNY ç›ˆäºæ€»å’Œ (åº”ä¸º0): <span id="cny-discrepancy" class="font-bold text-yellow-400">0 CNY</span></p>
                </div>
                <div class="mt-4 sm:mt-0 flex space-x-3">
                    <button onclick="calculateSettlement()" class="btn-primary p-3 rounded-lg font-semibold bg-gray-600 hover:bg-gray-700">è®¡ç®—è½¬è´¦æ–¹æ¡ˆ</button>
                    <button onclick="saveSessionData()" id="save-session-btn" class="btn-primary p-3 rounded-lg font-semibold bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>ä¿å­˜ç‰Œå±€</button>
                    <button onclick="clearSession()" id="clear-session-btn" class="p-3 rounded-lg font-semibold bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>æ¸…ç©º</button>
                </div>
            </div>
            
            <!-- Transfer Solution -->
            <div id="transfer-solution" class="mt-6 p-4 rounded-lg bg-green-900/30 border border-green-600 hidden">
                <h3 class="text-lg font-semibold mb-2 text-green-400">ğŸ’¸ æœ€ä½³è½¬è´¦æ–¹æ¡ˆ (æœ€å°åŒ–æ¬¡æ•°)</h3>
                <ul id="transfer-list" class="space-y-1"></ul>
            </div>
        </div>
        
        <!-- Past Sessions List -->
        <div class="card p-6 rounded-xl mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">ğŸ“œ å†å²ç‰Œå±€è®°å½•</h2>
            <div class="flex justify-between items-center mb-4">
                <p class="text-sm text-gray-400">ç‚¹å‡»åˆ é™¤æŒ‰é’®å°†ä»ç§¯åˆ†æ¦œä¸­æ°¸ä¹…ç§»é™¤è¯¥ç‰Œå±€æ•°æ®ã€‚</p>
                <button onclick="loadPastSessions()" class="p-2 rounded-lg font-semibold text-sm bg-gray-600 hover:bg-gray-700">åˆ·æ–°è®°å½•</button>
            </div>
            <div id="past-sessions-list" class="space-y-3">
                <p class="text-center text-gray-500" id="sessions-loading-status">æ­£åœ¨åŠ è½½å†å²è®°å½•...</p>
            </div>
        </div>


        <!-- Leaderboard (Scoreboard) -->
        <div class="card p-6 rounded-xl">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">ğŸ“Š æ€»ç§¯åˆ†æ¦œ (Leaderboard)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700 rounded-lg overflow-hidden">
                    <thead class="table-header">
                        <tr>
                            <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">ç©å®¶</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">æ€»ç›ˆäº (CNY)</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">å¹³å‡ç›ˆäº</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">èƒœç‡ (%)</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">æ³¢åŠ¨ç‡ (CNY)</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">Sharpe Ratio</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">æœ€å¤§è¿äº (æ¬¡æ•°)</th>
                            <th class="p-3 text-center text-xs font-medium uppercase tracking-wider">æ€»å±€æ•°</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body" class="divide-y divide-gray-800">
                        <tr id="leaderboard-placeholder"><td colspan="8" class="p-4 text-center text-gray-400">åŠ è½½ä¸­... è¯·ç¡®ä¿å·²ä¿å­˜ç‰Œå±€æ•°æ®ã€‚</td></tr>
                    </tbody>
                </table>
            </div>
            <button onclick="loadScoreboard()" class="btn-primary mt-4 p-2 rounded-lg font-semibold bg-gray-600 hover:bg-gray-700">åˆ·æ–°ç§¯åˆ†æ¦œ</button>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, getDoc, deleteDoc, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Authorization Configuration ---
        // âš ï¸ å…³é”®æ­¥éª¤ 1: è¯·å°†æ­¤é‚®ç®±æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„ Google è´¦æˆ·é‚®ç®±ï¼Œè¯¥è´¦æˆ·å°†æ‹¥æœ‰ç¼–è¾‘æƒé™
        const ADMIN_EMAIL = 'xirry.xyz@gmail.com'; 
        let isAdmin = false; 

        // Global variables for Firebase services
        let db;
        let auth;
        let userId = 'anonymous'; // Default user ID

        // Configuration and Session Data
        let config = {
            chipsPerEntry: 3000,
            cnyPerEntry: 300
        };
        let sessionPlayers = [];

        // --- Firebase Configuration ---
        // âš ï¸ å…³é”®æ­¥éª¤ 2: è¿™æ˜¯æ‚¨æä¾›çš„é…ç½®ã€‚è¯·ç”¨æ‚¨åœ¨ Firebase æ§åˆ¶å°è·å–çš„å®Œæ•´ã€æ­£ç¡®çš„ API å¯†é’¥æ›¿æ¢ 'REPLACE_WITH_YOUR_API_KEY'
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "***REMOVED***", // <-- è¯·æ›¿æ¢æ­¤å¤„çš„ API å¯†é’¥
            authDomain: "de1de-calculator.firebaseapp.com",
            projectId: "de1de-calculator",
            storageBucket: "de1de-calculator.firebasestorage.app",
            messagingSenderId: "1076456073032",
            appId: "1:1076456073032:web:5402bb2cb74e6940bf757d"
        };
        
        // App ID (MANDATORY)
        // åœ¨ Canvas ç¯å¢ƒä¸­ï¼Œä½¿ç”¨ __app_idï¼›å¦åˆ™ï¼Œä½¿ç”¨ Firebase project ID ä½œä¸ºé»˜è®¤ App ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : MANUAL_FIREBASE_CONFIG.projectId;

        // ä¼˜å…ˆæ£€æŸ¥ Canvas æ³¨å…¥çš„é…ç½® (__firebase_config)ï¼Œå¦åˆ™ä½¿ç”¨æ‰‹åŠ¨é…ç½® (MANUAL_FIREBASE_CONFIG)
        const firebaseConfig = 
            typeof __firebase_config !== 'undefined' && __firebase_config.length > 0
            ? JSON.parse(__firebase_config) 
            : MANUAL_FIREBASE_CONFIG;
        
        // --- End of Configuration ---


        // Expose global functions to the window object
        window.updateConfig = updateConfig;
        window.addPlayerToSession = addPlayerToSession;
        window.removePlayer = removePlayer;
        window.calculateSettlement = calculateSettlement;
        window.saveSessionData = saveSessionData;
        window.clearSession = clearSession;
        window.loadScoreboard = loadScoreboard;
        window.loadPastSessions = loadPastSessions;
        window.deleteSession = deleteSession;
        window.signInWithGoogle = signInWithGoogle;
        window.signOutUser = signOutUser;


        // --- Core Functions ---

        function getPublicCollection(collectionName) {
            // Firestore Security Rules path: /artifacts/{appId}/public/data/{your_collection_name}
            // âš ï¸ å»ºè®®çš„å®‰å…¨è§„åˆ™å¿…é¡»å…è®¸æœªç»è®¤è¯çš„ç”¨æˆ·è¯»å–ï¼Œå¹¶ä»…å…è®¸ç®¡ç†å‘˜å†™å…¥ã€‚
            return collection(db, `artifacts/${appId}/public/data/${collectionName}`);
        }

        /**
         * åˆ‡æ¢ç¼–è¾‘ç•Œé¢çš„å¯ç”¨/ç¦ç”¨çŠ¶æ€
         */
        function toggleEditingUI(enable) {
            const elementsToToggle = [
                'chipsPerEntry', 'cnyPerEntry', 'update-config-btn', 
                'playerName', 'playerEntries', 'playerFinalChips', 'add-player-btn', 
                'save-session-btn', 'clear-session-btn'
            ];
            
            elementsToToggle.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.disabled = !enable;
                    if (el.tagName === 'BUTTON') {
                        el.classList.toggle('opacity-50', !enable);
                        el.classList.toggle('cursor-not-allowed', !enable);
                    }
                }
            });

            // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°ç§»é™¤å’Œåˆ é™¤æŒ‰é’®çš„çŠ¶æ€
            updateSessionSummary();
            loadPastSessions(); 
        }

        /**
         * Google ç™»å½•
         */
        async function signInWithGoogle() {
            if (!auth) return;
            const provider = new GoogleAuthProvider();
            try {
                // è¦æ±‚ç”¨æˆ·é€‰æ‹©è´¦æˆ·
                provider.setCustomParameters({
                    prompt: 'select_account'
                });
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                // æ£€æŸ¥æ˜¯å¦æ˜¯ API å¯†é’¥é”™è¯¯ï¼Œç»™å‡ºæ›´æ˜ç¡®çš„æç¤º
                let errorMessage = `Google ç™»å½•å‡ºé”™: ${error.message}`;
                if (error.code === 'auth/api-key-not-valid') {
                     errorMessage = `API å¯†é’¥æ— æ•ˆã€‚è¯·æ£€æŸ¥ index.html æ–‡ä»¶ä¸­çš„ 'apiKey' é…ç½®æ˜¯å¦å®Œæ•´ä¸”æ­£ç¡®ã€‚`;
                }
                alertModal("ç™»å½•å¤±è´¥", errorMessage);
            }
        }

        /**
         * é€€å‡ºç™»å½•
         */
        async function signOutUser() {
            if (!auth) return;
            try {
                await signOut(auth);
                alertModal("æ“ä½œæˆåŠŸ", "æ‚¨å·²æˆåŠŸé€€å‡ºç™»å½•ã€‚");
            } catch (error) {
                console.error("Sign Out failed:", error);
                alertModal("æ“ä½œå¤±è´¥", `é€€å‡ºç™»å½•å‡ºé”™: ${error.message}`);
            }
        }


        /**
         * åˆå§‹åŒ–Firebaseå’Œè®¤è¯
         */
        async function initializeFirebase() {
            // æ£€æŸ¥ API å¯†é’¥æ˜¯å¦å·²æ›¿æ¢
            if (firebaseConfig.apiKey === 'REPLACE_WITH_YOUR_API_KEY') {
                document.getElementById('auth-status').textContent = 'é”™è¯¯: è¯·åœ¨ä»£ç ä¸­æ›¿æ¢ API å¯†é’¥åå†éƒ¨ç½²ã€‚';
                document.getElementById('auth-button').disabled = true;
                return;
            }

            if (!firebaseConfig || !firebaseConfig.projectId) {
                console.error("Firebase config is missing or incomplete.");
                document.getElementById('auth-status').textContent = 'é”™è¯¯: Firebaseé…ç½®ç¼ºå¤±æˆ–æ— æ•ˆã€‚è¯·åœ¨ä»£ç ä¸­æ£€æŸ¥é…ç½®ã€‚';
                return;
            }
            try {
                // setLogLevel('Debug'); // For debugging in console
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
                onAuthStateChanged(auth, (user) => {
                    const authButton = document.getElementById('auth-button');
                    const authStatus = document.getElementById('auth-status');
                    const adminStatus = document.getElementById('admin-status');
                    
                    if (user) {
                        userId = user.uid;
                        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜ï¼Œæ— è®ºä»–ä»¬æ˜¯å¦‚ä½•ç™»å½•çš„
                        isAdmin = (user.email === ADMIN_EMAIL);
                        authStatus.textContent = `å½“å‰ç”¨æˆ·: ${user.email || user.uid} (ID: ${userId})`;
                        authButton.textContent = 'é€€å‡ºç™»å½•';
                        authButton.onclick = signOutUser;
                        authButton.disabled = false;
                        authButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        authButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
                        
                        if (isAdmin) {
                            adminStatus.textContent = 'ğŸ‘‘ æ‚¨æ˜¯ç®¡ç†å‘˜ï¼Œæ‹¥æœ‰å…¨éƒ¨ç¼–è¾‘æƒé™ã€‚';
                            adminStatus.classList.remove('text-yellow-400', 'text-red-400');
                            adminStatus.classList.add('text-green-400');
                        } else {
                            adminStatus.textContent = 'ğŸ”’ ç¼–è¾‘åŠŸèƒ½å·²é”å®šã€‚è¯·è”ç³»ç®¡ç†å‘˜è·å–æƒé™ã€‚';
                            adminStatus.classList.add('text-yellow-400');
                            adminStatus.classList.remove('text-green-400', 'text-red-400');
                        }

                        // åŠ è½½æ•°æ®å¹¶åˆ‡æ¢UI
                        loadConfigFromStorage();
                        loadScoreboard();
                        loadPastSessions(); 
                        toggleEditingUI(isAdmin); // æ ¹æ®æƒé™åˆ‡æ¢UI
                    } else {
                        userId = 'anonymous';
                        isAdmin = false;
                        authStatus.textContent = 'æœªç™»å½•ã€‚è¯·ä½¿ç”¨ Google è´¦æˆ·ç™»å½•ã€‚';
                        adminStatus.textContent = 'ğŸ”’ ç¼–è¾‘åŠŸèƒ½å·²é”å®šã€‚';
                        adminStatus.classList.add('text-red-400');
                        adminStatus.classList.remove('text-green-400', 'text-yellow-400');

                        authButton.textContent = 'ä½¿ç”¨ Google ç™»å½•';
                        authButton.onclick = signInWithGoogle;
                        authButton.disabled = false;
                        authButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                        authButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');

                        // å³ä½¿æœªç™»å½•ä¹Ÿå°è¯•åŠ è½½å…¬å…±æ•°æ® (å¦‚æœå®‰å…¨è§„åˆ™å…è®¸)
                        loadConfigFromStorage();
                        loadScoreboard();
                        loadPastSessions();
                        toggleEditingUI(isAdmin); // ç¦ç”¨ç¼–è¾‘UI
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization or Auth Failed:", error);
                document.getElementById('auth-status').textContent = 'é”™è¯¯: Firebaseåˆå§‹åŒ–å¤±è´¥ã€‚';
            }
        }

        /**
         * ä»FirestoreåŠ è½½é…ç½®
         */
        function loadConfigFromStorage() {
            const configStatus = document.getElementById('config-status');
            if (!db) {
                configStatus.textContent = 'æ•°æ®åº“æœªè¿æ¥ã€‚';
                return;
            }
            
            const configRef = doc(getPublicCollection('config'), 'game-config');
            
            try {
                onSnapshot(configRef, (docSnap) => {
                    if (docSnap.exists()) {
                        config = docSnap.data();
                        document.getElementById('chipsPerEntry').value = config.chipsPerEntry;
                        document.getElementById('cnyPerEntry').value = config.cnyPerEntry;
                        configStatus.textContent = 'é…ç½®å·²ä»äº‘ç«¯åŠ è½½ã€‚';
                    } else {
                        console.log("No config found, using default.");
                        configStatus.textContent = 'ä½¿ç”¨é»˜è®¤é…ç½®ã€‚';
                    }
                    updateSessionSummary(); // Recalculate if config changes
                }, (error) => {
                    // ä»…åœ¨æ§åˆ¶å°è®°å½•é”™è¯¯ï¼Œä¸å‘ç”¨æˆ·æ˜¾ç¤ºâ€œæƒé™ä¸è¶³â€çš„å¼¹çª—
                    if (error.code === 'permission-denied') {
                        console.warn("[CONSOLE_WARN] Error loading config (Permission Denied). Check Firestore rules.");
                        configStatus.textContent = 'é…ç½®æ•°æ®åŠ è½½å¤±è´¥ (åªè¯»æ¨¡å¼)ã€‚';
                    } else {
                        console.error("Error loading config:", error);
                        configStatus.textContent = `åŠ è½½é…ç½®å¤±è´¥: ${error.message}`;
                    }
                });
            } catch (e) {
                // æ•è· onSnapshot è®¾ç½®æ—¶çš„é”™è¯¯
                 console.error("Error setting up config listener:", e);
            }
        }

        /**
         * æ›´æ–°é…ç½®å¹¶ä¿å­˜åˆ°Firestore
         */
        async function updateConfig() {
            if (!isAdmin) {
                alertModal("æ“ä½œå¤±è´¥", "ç¼–è¾‘åŠŸèƒ½å·²é”å®šã€‚");
                return;
            }
            if (!db) {
                alertModal("æ“ä½œå¤±è´¥", "æ•°æ®åº“æœªè¿æ¥ã€‚");
                return;
            }

            const chips = parseFloat(document.getElementById('chipsPerEntry').value);
            const cny = parseFloat(document.getElementById('cnyPerEntry').value);

            if (isNaN(chips) || chips <= 0 || isNaN(cny) || cny <= 0) {
                alertModal("è¾“å…¥é”™è¯¯", "è¯·è¾“å…¥æœ‰æ•ˆçš„æ­£æ•°ã€‚");
                document.getElementById('config-status').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ­£æ•°ã€‚';
                return;
            }

            config.chipsPerEntry = chips;
            config.cnyPerEntry = cny;

            const configRef = doc(getPublicCollection('config'), 'game-config');
            try {
                await setDoc(configRef, config, { merge: true });
                document.getElementById('config-status').textContent = 'é…ç½®å·²æ›´æ–°å¹¶ä¿å­˜åˆ°äº‘ç«¯ã€‚';
            } catch (e) {
                console.error("Error saving config:", e);
                alertModal("ä¿å­˜å¤±è´¥", `ä¿å­˜é…ç½®å¤±è´¥: ${e.message}`);
                document.getElementById('config-status').textContent = 'ä¿å­˜é…ç½®å¤±è´¥ã€‚';
            }
            
            updateSessionSummary();
        }

        /**
         * æ·»åŠ ç©å®¶åˆ°å½“å‰ç‰Œå±€
         */
        function addPlayerToSession() {
            if (!isAdmin) {
                alertModal("æ“ä½œå¤±è´¥", "ç¼–è¾‘åŠŸèƒ½å·²é”å®šã€‚");
                return;
            }

            const name = document.getElementById('playerName').value.trim();
            const entries = parseFloat(document.getElementById('playerEntries').value);
            const finalChips = parseFloat(document.getElementById('playerFinalChips').value);

            if (!name || isNaN(entries) || isNaN(finalChips) || finalChips < 0) {
                alertModal("è¾“å…¥é”™è¯¯", "è¯·ç¡®ä¿ç©å®¶å§“åä¸ä¸ºç©ºï¼Œå‡€ä¹°å…¥æ¬¡æ•°æ˜¯æœ‰æ•ˆçš„æ•°å­—ï¼Œä¸”æœ€ç»ˆç­¹ç ä¸ºæœ‰æ•ˆçš„éè´Ÿæ•°å­—ã€‚");
                return;
            }
            
            const totalBuyInChips = entries * config.chipsPerEntry;
            const pnlChips = finalChips - totalBuyInChips;
            const pnlCNY = pnlChips * (config.cnyPerEntry / config.chipsPerEntry);

            const existingIndex = sessionPlayers.findIndex(p => p.name === name);

            const newPlayer = {
                id: Date.now() + Math.random(), // Unique ID for table row
                name,
                entries,
                totalBuyInChips: Math.round(totalBuyInChips),
                finalChips: Math.round(finalChips),
                pnlChips: Math.round(pnlChips),
                pnlCNY: parseFloat(pnlCNY.toFixed(2)),
                adjustedPnLCNY: parseFloat(pnlCNY.toFixed(2)) // Initial value before adjustment
            };

            if (existingIndex !== -1) {
                sessionPlayers[existingIndex] = newPlayer;
            } else {
                sessionPlayers.push(newPlayer);
            }

            // Clear input fields for next entry
            document.getElementById('playerName').value = '';
            document.getElementById('playerEntries').value = '2';
            document.getElementById('playerFinalChips').value = '3000';

            updateSessionSummary();
        }
        
        /**
         * ç§»é™¤ç©å®¶
         */
        function removePlayer(id) {
            if (!isAdmin) {
                alertModal("æ“ä½œå¤±è´¥", "ç¼–è¾‘åŠŸèƒ½å·²é”å®šã€‚");
                return;
            }
            sessionPlayers = sessionPlayers.filter(p => p.id !== id);
            updateSessionSummary();
        }

        /**
         * æ ¹æ®ç”¨æˆ·æŒ‡å®šçš„ä¼˜å…ˆçº§è°ƒæ•´ç›ˆäºä»¥æŠ¹å¹³ç­¹ç å·®é¢
         */
        function adjustDiscrepancy(players) {
            let totalPnL = players.reduce((sum, p) => sum + p.pnlCNY, 0);

            if (Math.abs(totalPnL) < 0.01) {
                return players.map(p => ({ ...p, adjustedPnLCNY: p.pnlCNY }));
            }

            const adjustedPlayers = players.map(p => ({ ...p, adjustedPnLCNY: p.pnlCNY }));
            const adjustmentMagnitude = Math.abs(totalPnL); 

            if (totalPnL > 0) { 
                const winners = adjustedPlayers.filter(p => p.adjustedPnLCNY > 0);
                const totalWinMagnitude = winners.reduce((sum, p) => sum + p.adjustedPnLCNY, 0);
                
                if (totalWinMagnitude > 0) {
                    winners.forEach(p => {
                        const ratio = p.adjustedPnLCNY / totalWinMagnitude;
                        p.adjustedPnLCNY -= adjustmentMagnitude * ratio; 
                    });
                }
            
            } else { 
                const losers = adjustedPlayers.filter(p => p.adjustedPnLCNY < 0);
                const totalLossMagnitude = losers.reduce((sum, p) => sum + Math.abs(p.adjustedPnLCNY), 0);
                
                if (totalLossMagnitude > 0) {
                    losers.forEach(p => {
                        const ratio = Math.abs(p.adjustedPnLCNY) / totalLossMagnitude;
                        p.adjustedPnLCNY += adjustmentMagnitude * ratio;
                    });
                }
            }
            
            return adjustedPlayers.map(p => ({ ...p, adjustedPnLCNY: parseFloat(p.adjustedPnLCNY.toFixed(2)) }));
        }

        /**
         * æ›´æ–°å½“å‰ç‰Œå±€çš„æ•°æ®è¡¨æ ¼å’Œæ±‡æ€»ä¿¡æ¯
         */
        function updateSessionSummary() {
            sessionPlayers = adjustDiscrepancy(sessionPlayers.map(p => ({ ...p, pnlCNY: p.pnlCNY })));

            const tbody = document.getElementById('session-data-body');
            const saveBtn = document.getElementById('save-session-btn');
            tbody.innerHTML = '';
            
            let totalBuyInChips = 0;
            let totalFinalChips = 0;
            let totalPnLCNY = 0;

            if (sessionPlayers.length === 0) {
                tbody.innerHTML = '<tr id="session-placeholder"><td colspan="7" class="p-4 text-center text-gray-400">è¯·æ·»åŠ ç©å®¶æ•°æ®...</td></tr>';
                saveBtn.disabled = true;
                document.getElementById('clear-session-btn').disabled = true;
            } else {
                saveBtn.disabled = !isAdmin;
                document.getElementById('clear-session-btn').disabled = !isAdmin;
                
                sessionPlayers.forEach(p => {
                    totalBuyInChips += p.totalBuyInChips;
                    totalFinalChips += p.finalChips;
                    totalPnLCNY += p.adjustedPnLCNY;

                    const pnlClass = p.adjustedPnLCNY > 0.01 ? 'text-win' : p.adjustedPnLCNY < -0.01 ? 'text-loss' : 'text-neutral';
                    
                    const removeBtnHtml = isAdmin ? `
                        <button onclick="removePlayer(${p.id})" class="text-red-500 hover:text-red-400 text-sm font-semibold">ç§»é™¤</button>
                    ` : `
                        <span class="text-gray-600 text-sm cursor-not-allowed">é”å®š</span>
                    `;

                    const row = `
                        <tr class="hover:bg-gray-800/70 transition-colors">
                            <td class="p-3 font-semibold">${p.name}</td>
                            <td class="p-3 text-right">${p.totalBuyInChips}</td>
                            <td class="p-3 text-right">${p.finalChips}</td>
                            <td class="p-3 text-right ${pnlClass}">${p.pnlChips}</td>
                            <td class="p-3 text-right ${pnlClass}">${p.pnlCNY.toFixed(2)} CNY</td>
                            <td class="p-3 text-right ${pnlClass} font-bold">${p.adjustedPnLCNY.toFixed(2)} CNY</td>
                            <td class="p-3 text-center">${removeBtnHtml}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            document.getElementById('total-buy-in').textContent = Math.round(totalBuyInChips);
            document.getElementById('total-final-chips').textContent = Math.round(totalFinalChips);
            const chipDiscrepancy = Math.round(totalFinalChips - totalBuyInChips);
            document.getElementById('chip-discrepancy').textContent = chipDiscrepancy;
            
            const cnyDiscrepancyElement = document.getElementById('cny-discrepancy');
            cnyDiscrepancyElement.textContent = `${totalPnLCNY.toFixed(2)} CNY`;
            cnyDiscrepancyElement.className = totalPnLCNY > 0.01 ? 'font-bold text-win' : totalPnLCNY < -0.01 ? 'font-bold text-loss' : 'font-bold text-green-400';
            
            if (document.getElementById('transfer-solution').classList.contains('block')) {
                calculateTransfers(sessionPlayers);
            }
        }
        
        /**
         * è®¡ç®—æœ€å°è½¬è´¦æ–¹æ¡ˆ (Schrage/Greedy Algorithm)
         */
        function calculateSettlement() {
            if (sessionPlayers.length === 0) {
                 alertModal("ç»“ç®—å¤±è´¥", "è¯·å…ˆæ·»åŠ ç©å®¶æ•°æ®ã€‚");
                return;
            }

            const adjustedPlayers = sessionPlayers.map(p => ({
                name: p.name,
                pnl: p.adjustedPnLCNY
            }));

            const transfers = calculateTransfers(adjustedPlayers);
            const transferList = document.getElementById('transfer-list');
            const solutionDiv = document.getElementById('transfer-solution');
            transferList.innerHTML = '';

            if (transfers.length === 0) {
                transferList.innerHTML = `<li class="text-green-300">ğŸ‰ æ‰€æœ‰ç©å®¶ç›ˆäºä¸ºé›¶ï¼Œæ— éœ€è½¬è´¦ï¼</li>`;
            } else {
                transfers.forEach(t => {
                    const listItem = `<li><span class="font-bold">${t.from}</span> â†’ <span class="font-bold">${t.to}</span>: <span class="text-green-300">${t.amount.toFixed(2)} CNY</span></li>`;
                    transferList.innerHTML += listItem;
                });
            }

            solutionDiv.classList.remove('hidden');
            solutionDiv.classList.add('block');
        }

        function calculateTransfers(players) {
            const transfers = [];
            
            let winners = players.filter(p => p.pnl > 0).map(p => ({ ...p, pnl: parseFloat(p.pnl.toFixed(2)) }));
            let losers = players.filter(p => p.pnl < 0).map(p => ({ ...p, pnl: parseFloat(p.pnl.toFixed(2)) }));

            winners.sort((a, b) => b.pnl - a.pnl);
            losers.sort((a, b) => a.pnl - b.pnl);

            while (winners.length > 0 && losers.length > 0) {
                const winner = winners[0];
                const loser = losers[0];

                const debt = Math.abs(loser.pnl);
                const credit = winner.pnl;

                const amount = Math.min(debt, credit);

                transfers.push({
                    from: loser.name,
                    to: winner.name,
                    amount: amount
                });

                winner.pnl -= amount;
                loser.pnl += amount; 

                if (Math.abs(winner.pnl) < 0.01) {
                    winners.shift();
                }
                if (Math.abs(loser.pnl) < 0.01) {
                    losers.shift();
                }
            }
            return transfers;
        }

        /**
         * å°†å½“å‰ç‰Œå±€æ•°æ®ä¿å­˜åˆ°Firestore
         */
        async function saveSessionData() {
            if (!isAdmin) {
                alertModal("æ“ä½œå¤±è´¥", "ç¼–è¾‘åŠŸèƒ½å·²é”å®šã€‚");
                return;
            }
            if (sessionPlayers.length === 0) {
                alertModal("ä¿å­˜å¤±è´¥", "å½“å‰ç‰Œå±€æ²¡æœ‰ç©å®¶æ•°æ®ã€‚");
                return;
            }
            if (!db) {
                alertModal("ä¿å­˜å¤±è´¥", "æ•°æ®åº“æœªè¿æ¥æˆ–è®¤è¯å¤±è´¥ã€‚");
                return;
            }

            const sessionId = Date.now().toString(); // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ID
            const sessionData = {
                id: sessionId, 
                date: new Date().toISOString(),
                config: config,
                playerResults: sessionPlayers.map(p => ({
                    name: p.name,
                    pnlCNY: p.adjustedPnLCNY,
                    isWin: p.adjustedPnLCNY > 0.01
                }))
            };

            const sessionRef = doc(getPublicCollection('sessions'), sessionId);
            try {
                await setDoc(sessionRef, sessionData);
            } catch (e) {
                console.error("Error saving session data:", e);
                alertModal("ä¿å­˜å¤±è´¥", `ä¿å­˜ç‰Œå±€æ•°æ®æ—¶å‡ºé”™: ${e.message}`);
                return;
            }

            try {
                 await runTransaction(db, async (transaction) => {
                    const updates = new Map(); 

                    for (const player of sessionPlayers) {
                        const playerRef = doc(getPublicCollection('scoreboard'), player.name);
                        
                        const docSnapshot = await transaction.get(playerRef); 
                        
                        const newHistoryEntry = { sessionId: sessionId, date: sessionData.date, pnl: player.adjustedPnLCNY };
                        let history = [];

                        if (docSnapshot.exists()) {
                            const data = docSnapshot.data();
                            if (data.history && Array.isArray(data.history)) {
                                history = data.history.filter(h => h.sessionId !== sessionId); // ç¡®ä¿æ²¡æœ‰é‡å¤è®°å½•
                            }
                        }
                        
                        history.push(newHistoryEntry);
                        
                        updates.set(player.name, {
                            ref: playerRef,
                            data: {
                                name: player.name,
                                history: history,
                            }
                        });
                    }
                    
                    for (const update of updates.values()) {
                        transaction.set(update.ref, update.data, { merge: true });
                    }
                });

                alertModal("ä¿å­˜æˆåŠŸ", `ç‰Œå±€å·²æˆåŠŸä¿å­˜å¹¶æ›´æ–°ç§¯åˆ†æ¦œæ•°æ®ã€‚`);
                clearSession();
                loadScoreboard();
                loadPastSessions();

            } catch (e) {
                console.error("Error updating scoreboard in transaction:", e);
                alertModal("ä¿å­˜å¤±è´¥", `æ›´æ–°ç§¯åˆ†æ¦œæ—¶å‡ºé”™ (äº‹åŠ¡å¤±è´¥): ${e.message}`);
            }
        }

        /**
         * æ¸…ç©ºå½“å‰ç‰Œå±€æ•°æ®
         */
        function clearSession() {
            if (!isAdmin) {
                alertModal("æ“ä½œå¤±è´¥", "ç¼–è¾‘åŠŸèƒ½å·²é”å®šã€‚");
                return;
            }
            sessionPlayers = [];
            document.getElementById('transfer-solution').classList.remove('block');
            document.getElementById('transfer-solution').classList.add('hidden');
            updateSessionSummary();
        }

        // --- Session Management ---

        /**
         * åŠ è½½å¹¶æ˜¾ç¤ºæ‰€æœ‰å†å²ç‰Œå±€
         */
        async function loadPastSessions() {
            const sessionListDiv = document.getElementById('past-sessions-list');
            const statusElement = document.getElementById('sessions-loading-status');
            
            sessionListDiv.innerHTML = '<p class="text-center text-gray-500" id="sessions-loading-status">æ­£åœ¨åŠ è½½å†å²è®°å½•...</p>';
            
            if (!db) {
                document.getElementById('sessions-loading-status').textContent = 'æ•°æ®åº“æœªè¿æ¥ã€‚è¯·ç¨å€™æˆ–ç™»å½•ã€‚';
                return;
            }

            try {
                const snapshot = await getDocs(getPublicCollection('sessions'));
                const sessions = [];
                snapshot.forEach(doc => {
                    sessions.push({ id: doc.id, ...doc.data() });
                });

                sessions.sort((a, b) => new Date(b.date) - new Date(a.date));

                sessionListDiv.innerHTML = ''; // Clear status message

                if (sessions.length === 0) {
                    sessionListDiv.innerHTML = '<p class="text-center text-gray-500">æš‚æ— å·²ä¿å­˜çš„ç‰Œå±€è®°å½•ã€‚</p>';
                } else {
                    sessions.forEach(session => {
                        const date = new Date(session.date).toLocaleString('zh-CN', {
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit'
                        });
                        
                        const playerSummary = session.playerResults.map(p => {
                            const pnlClass = p.pnlCNY > 0.01 ? 'text-win' : p.pnlCNY < -0.01 ? 'text-loss' : 'text-neutral';
                            return `<span class="text-sm font-medium ${pnlClass}">${p.name} (${p.pnlCNY.toFixed(2)})</span>`;
                        }).join(', ');
                        
                        // æ ¹æ®æƒé™æ˜¾ç¤ºåˆ é™¤æŒ‰é’®æˆ–é”å®šæ ‡è®°
                        const deleteBtn = isAdmin ? `
                            <button onclick="deleteSession('${session.id}', ${JSON.stringify(session.playerResults).replace(/'/g, "\\'")})" 
                                class="p-2 rounded-lg font-semibold text-sm bg-red-700 hover:bg-red-800 w-full sm:w-auto flex-shrink-0">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>` : `
                            <span class="p-2 rounded-lg font-semibold text-sm bg-gray-600 text-gray-400 w-full sm:w-auto flex-shrink-0 text-center cursor-not-allowed">
                                ğŸ”’ é”å®š
                            </span>`;

                        const sessionElement = document.createElement('div');
                        sessionElement.className = 'card p-4 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-2 sm:space-y-0';
                        sessionElement.innerHTML = `
                            <div class="flex flex-col w-full sm:w-3/4">
                                <span class="text-base font-semibold text-white">ç‰Œå±€æ—¶é—´: ${date}</span>
                                <span class="text-sm text-gray-400 mt-1">æ€»ç»“: ${playerSummary}</span>
                            </div>
                            ${deleteBtn}
                        `;
                        sessionListDiv.appendChild(sessionElement);
                    });
                }
            } catch (e) {
                // ä»…åœ¨æ§åˆ¶å°è®°å½•é”™è¯¯ï¼Œä¸å‘ç”¨æˆ·æ˜¾ç¤ºâ€œæƒé™ä¸è¶³â€çš„å¼¹çª—
                if (e.code === 'permission-denied') {
                    console.warn("[CONSOLE_WARN] Error loading past sessions (Permission Denied). Check Firestore rules.");
                    sessionListDiv.innerHTML = `<p class="text-center text-gray-500">å†å²è®°å½•åŠ è½½å¤±è´¥ (åªè¯»æ¨¡å¼)ã€‚</p>`;
                } else {
                    console.error("Error loading past sessions:", e);
                    sessionListDiv.innerHTML = `<p class="text-center text-red-400">åŠ è½½å†å²è®°å½•å¤±è´¥: ${e.message}</p>`;
                }
            }
        }

        /**
         * åˆ é™¤æŒ‡å®šçš„ç‰Œå±€è®°å½•å¹¶æ›´æ–°æ‰€æœ‰å—å½±å“çš„ç§¯åˆ†æ¦œ
         */
        async function deleteSession(sessionId, playerResults) {
            if (!isAdmin) {
                alertModal("æ“ä½œå¤±è´¥", "ç¼–è¾‘åŠŸèƒ½å·²é”å®šã€‚");
                return;
            }
            if (!db) {
                alertModal("æ“ä½œå¤±è´¥", "æ•°æ®åº“æœªè¿æ¥ã€‚");
                return;
            }

            // ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ€æ¡†æ›¿ä»£ window.confirm
            const confirmAction = await new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="card p-6 rounded-xl w-full max-w-md">
                        <h3 class="text-xl font-bold mb-3 text-red-500">ç¡®è®¤åˆ é™¤</h3>
                        <p class="text-gray-300 mb-4">ç¡®å®šè¦æ°¸ä¹…åˆ é™¤ç‰Œå±€ ID: ${sessionId} å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚</p>
                        <div class="flex justify-end space-x-3">
                            <button id="modal-cancel-btn" class="p-3 rounded-lg font-semibold bg-gray-600 hover:bg-gray-700">å–æ¶ˆ</button>
                            <button id="modal-delete-btn" class="p-3 rounded-lg font-semibold bg-red-600 hover:bg-red-700">æ°¸ä¹…åˆ é™¤</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('modal-cancel-btn').onclick = () => { document.body.removeChild(modal); resolve(false); };
                document.getElementById('modal-delete-btn').onclick = () => { document.body.removeChild(modal); resolve(true); };
            });

            if (!confirmAction) {
                return;
            }
            
            const sessionRef = doc(getPublicCollection('sessions'), sessionId);

            try {
                await runTransaction(db, async (transaction) => {
                    const scoreboardUpdates = new Map(); 

                    for (const result of playerResults) {
                        const playerRef = doc(getPublicCollection('scoreboard'), result.name);
                        const docSnapshot = await transaction.get(playerRef);

                        if (docSnapshot.exists()) {
                            const data = docSnapshot.data();
                            let history = data.history || [];

                            const updatedHistory = history.filter(h => h.sessionId !== sessionId);
                            
                            scoreboardUpdates.set(result.name, {
                                ref: playerRef,
                                data: {
                                    name: result.name,
                                    history: updatedHistory,
                                }
                            });
                        }
                    }

                    for (const update of scoreboardUpdates.values()) {
                        transaction.set(update.ref, update.data, { merge: true });
                    }
                    
                    transaction.delete(sessionRef);
                });

                alertModal("åˆ é™¤æˆåŠŸ", `ç‰Œå±€ ${sessionId} å·²æˆåŠŸåˆ é™¤å¹¶æ›´æ–°äº†ç§¯åˆ†æ¦œã€‚`);
                
                loadScoreboard();
                loadPastSessions();

            } catch (e) {
                console.error("Error deleting session in transaction:", e);
                alertModal("åˆ é™¤å¤±è´¥", `åˆ é™¤ç‰Œå±€å’Œæ›´æ–°ç§¯åˆ†æ¦œæ—¶å‡ºé”™: ${e.message}`);
            }
        }


        // --- Scoreboard / Metrics Calculation ---

        /**
         * ä»FirestoreåŠ è½½å¹¶è®¡ç®—ç§¯åˆ†æ¦œ
         */
        async function loadScoreboard() {
            const leaderboardPlaceholder = document.getElementById('leaderboard-placeholder');
            
            if (!db) {
                leaderboardPlaceholder.textContent = 'æ•°æ®åº“æœªè¿æ¥ã€‚è¯·ç¨å€™æˆ–ç™»å½•ã€‚';
                return;
            }

            leaderboardPlaceholder.textContent = 'æ­£åœ¨ä»äº‘ç«¯åŠ è½½æ•°æ®...';
            
            try {
                const snapshot = await getDocs(getPublicCollection('scoreboard'));
                const playerStatsMap = new Map();

                const allHistory = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.history && Array.isArray(data.history)) {
                        data.history.forEach(h => {
                             allHistory.push({ name: data.name, ...h });
                        });
                    }
                });

                const groupedHistory = allHistory.reduce((acc, item) => {
                    if (!acc[item.name]) acc[item.name] = [];
                    acc[item.name].push(item);
                    return acc;
                }, {});
                
                for (const name in groupedHistory) {
                    const history = groupedHistory[name].sort((a, b) => new Date(a.date) - new Date(b.date));
                    playerStatsMap.set(name, calculateMetrics(name, history));
                }

                renderLeaderboard([...playerStatsMap.values()]);
                
            } catch (e) {
                // ä»…åœ¨æ§åˆ¶å°è®°å½•é”™è¯¯ï¼Œä¸å‘ç”¨æˆ·æ˜¾ç¤ºâ€œæƒé™ä¸è¶³â€çš„å¼¹çª—
                if (e.code === 'permission-denied') {
                    console.warn("[CONSOLE_WARN] Error loading scoreboard (Permission Denied). Check Firestore rules.");
                    leaderboardPlaceholder.textContent = 'ç§¯åˆ†æ¦œæ•°æ®åŠ è½½å¤±è´¥ (åªè¯»æ¨¡å¼)ã€‚';
                } else {
                    console.error("Error loading scoreboard:", e);
                    leaderboardPlaceholder.textContent = `åŠ è½½ç§¯åˆ†æ¦œå¤±è´¥: ${e.message}`;
                }
            }
        }

        /**
         * è®¡ç®—å•ä¸ªç©å®¶çš„å…¨éƒ¨æŒ‡æ ‡
         */
        function calculateMetrics(name, history) {
            const pnls = history.map(h => h.pnl);
            const totalSessions = pnls.length;
            if (totalSessions === 0) {
                return { name, totalSessions: 0, totalPnL: 0, avgPnL: 0, winRate: 0, volatility: 0, sharpe: 0, maxLosingStreak: 0 };
            }

            const totalPnL = pnls.reduce((sum, pnl) => sum + pnl, 0);
            const avgPnL = totalPnL / totalSessions;

            const variance = pnls.reduce((sum, pnl) => sum + Math.pow(pnl - avgPnL, 2), 0) / totalSessions;
            const volatility = Math.sqrt(variance);

            const sharpe = volatility > 0 ? avgPnL / volatility : (avgPnL > 0 ? Infinity : 0);

            const sessionsWon = pnls.filter(pnl => pnl > 0.01).length;
            const winRate = (sessionsWon / totalSessions) * 100;

            // æœ€å¤§è¿äºæ¬¡æ•°
            let currentLosingStreak = 0;
            let maxLosingStreak = 0;

            for (const pnl of pnls) {
                if (pnl < -0.01) { 
                    currentLosingStreak++;
                } else {
                    currentLosingStreak = 0; 
                }
                maxLosingStreak = Math.max(maxLosingStreak, currentLosingStreak);
            }


            return {
                name,
                totalSessions,
                totalPnL: totalPnL,
                avgPnL: avgPnL,
                winRate: winRate,
                volatility: volatility,
                sharpe: sharpe,
                maxLosingStreak: maxLosingStreak
            };
        }

        /**
         * æ¸²æŸ“ç§¯åˆ†æ¦œè¡¨æ ¼
         */
        function renderLeaderboard(stats) {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '';
            
            if (stats.length === 0) {
                tbody.innerHTML = '<tr id="leaderboard-placeholder"><td colspan="8" class="p-4 text-center text-gray-400">æš‚æ— æ•°æ®ã€‚è¯·ä¿å­˜ä¸€æ¬¡ç‰Œå±€ã€‚</td></tr>';
                return;
            }

            stats.sort((a, b) => b.totalPnL - a.totalPnL);

            stats.forEach(s => {
                const pnlClass = s.totalPnL > 0.01 ? 'text-win' : s.totalPnL < -0.01 ? 'text-loss' : 'text-neutral';
                let sharpeText = isFinite(s.sharpe) ? s.sharpe.toFixed(2) : 'N/A';
                let sharpeClass = s.sharpe > 0.5 ? 'text-win' : s.sharpe > 0 ? 'text-yellow-400' : 'text-neutral';
                
                if (s.sharpe === Infinity) {
                    sharpeText = 'âˆ';
                    sharpeClass = 'text-green-400';
                }
                
                const row = `
                    <tr class="hover:bg-gray-800/70 transition-colors">
                        <td class="p-3 font-semibold">${s.name}</td>
                        <td class="p-3 text-right ${pnlClass} font-bold">${s.totalPnL.toFixed(2)}</td>
                        <td class="p-3 text-right">${s.avgPnL.toFixed(2)}</td>
                        <td class="p-3 text-right">${s.winRate.toFixed(1)}%</td>
                        <td class="p-3 text-right">${s.volatility.toFixed(2)}</td>
                        <td class="p-3 text-right ${sharpeClass}">${sharpeText}</td>
                        <td class="p-3 text-right text-loss font-bold">${s.maxLosingStreak}</td>
                        <td class="p-3 text-center">${s.totalSessions}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        // --- Utility ---

        function alertModal(title, message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="card p-6 rounded-xl w-full max-w-md">
                    <h3 class="text-xl font-bold mb-3 text-white">${title}</h3>
                    <p class="text-gray-300 mb-4">${message}</p>
                    <button id="modal-ok-btn" class="btn-primary w-full p-3 rounded-lg font-semibold">ç¡®å®š</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('modal-ok-btn').onclick = () => document.body.removeChild(modal);
        }
        
        // Initial setup on window load
        window.onload = initializeFirebase;

    </script>
</body>
</html>