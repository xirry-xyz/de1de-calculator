<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾·å·æ‰‘å…‹ç‰Œå±€è¿½è¸ªä¸ç§¯åˆ†æ¦œ</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .btn-primary {
            background-color: #238636;
            transition: background-color 0.2s;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #2ea043;
        }
        .input-field:disabled {
            background-color: #21262d;
            cursor: not-allowed;
        }
        .input-field {
            background-color: #0d1117;
            border-color: #30363d;
            color: #c9d1d9;
        }
        .table-header {
            background-color: #21262d;
            color: #f0f6fc;
        }
        .text-win { color: #2ea043; }
        .text-loss { color: #f85149; }
        .text-neutral { color: #c9d1d9; }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-admin { background-color: #f69d3c; color: #161b22; }
        .badge-private { background-color: #38a169; color: white; }
    </style>
</head>
<body>

    <div class="min-h-screen p-4 sm:p-8">
        <h1 class="text-3xl font-bold mb-8 text-center text-white">ğŸ´ å¾·å·æ‰‘å…‹ç»“ç®—ä¸ç§¯åˆ†æ¦œ ğŸ“ˆ</h1>
        
        <!-- Auth Status & Button -->
        <div class="card p-4 rounded-xl mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center bg-gray-800/50">
            <div>
                <p id="auth-status" class="text-sm text-yellow-400 font-medium">æ­£åœ¨è¿æ¥ Firebase å¹¶æ£€æŸ¥ç™»å½•çŠ¶æ€...</p>
                <p id="admin-status" class="text-xs mt-1 font-bold"></p>
                <p class="text-xs mt-1 text-gray-400">å½“å‰ç”¨æˆ·ID: <span id="user-id-display" class="font-mono text-gray-300">N/A</span></p>
            </div>
            <button id="auth-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg text-sm mt-3 sm:mt-0" disabled>
                åŠ è½½ä¸­...
            </button>
        </div>

        <!-- Session Configuration and New Player Input -->
        <div class="card p-6 rounded-xl mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">æœ¬å±€é…ç½®ä¸ç©å®¶æ•°æ®</h2>
            
            <!-- Session Configuration (Per Game) -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 p-4 rounded-lg bg-gray-800/50">
                <div>
                    <label for="chipsPerEntry" class="block text-sm font-medium mb-1">æ¯æ‰‹ä¹°å…¥ç­¹ç æ•° (æœ¬å±€)</label>
                    <input type="number" id="chipsPerEntry" value="3000" class="input-field w-full p-2 rounded-lg border focus:ring-green-500 focus:border-green-500" placeholder="ä¾‹å¦‚: 3000">
                </div>
                <div>
                    <label for="cnyPerEntry" class="block text-sm font-medium mb-1">æ¯æ‰‹ä¹°å…¥å¯¹åº” CNY (æœ¬å±€)</label>
                    <input type="number" id="cnyPerEntry" value="300" class="input-field w-full p-2 rounded-lg border focus:ring-green-500 focus:border-green-500" placeholder="ä¾‹å¦‚: 300">
                </div>
            </div>

            <!-- Player Input -->
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                <div>
                    <label for="playerName" class="block text-sm font-medium mb-1">ç©å®¶å§“å</label>
                    <input type="text" id="playerName" class="input-field w-full p-2 rounded-lg border" placeholder="A, B, C, D..." disabled>
                </div>
                <div>
                    <label for="playerEntries" class="block text-sm font-medium mb-1">å‡€ä¹°å…¥æ¬¡æ•° (å¯ä¸ºè´Ÿ)</label>
                    <input type="number" id="playerEntries" value="2" class="input-field w-full p-2 rounded-lg border" placeholder="ä¾‹å¦‚: 2 æˆ– -1" disabled>
                </div>
                <div>
                    <label for="playerFinalChips" class="block text-sm font-medium mb-1">æœ€ç»ˆç­¹ç æ•°</label>
                    <input type="number" id="playerFinalChips" value="3000" class="input-field w-full p-2 rounded-lg border" placeholder="ä¾‹å¦‚: 3000" disabled>
                </div>
                <div class="flex items-end">
                    <button onclick="addPlayerToSession()" id="add-player-btn" class="btn-primary w-full p-2 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed" disabled>æ·»åŠ ç©å®¶</button>
                </div>
            </div>
        </div>

        <!-- Session Results and Transfers -->
        <div class="card p-6 rounded-xl mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">å½“å‰ç‰Œå±€ç»“ç®—</h2>
            
            <!-- Player Data Table -->
            <div class="overflow-x-auto mb-6">
                <table class="min-w-full divide-y divide-gray-700 rounded-lg overflow-hidden">
                    <thead class="table-header">
                        <tr>
                            <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">ç©å®¶</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">æ€»ä¹°å…¥ (ç­¹ç )</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">æœ€ç»ˆç­¹ç </th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">P&L (ç­¹ç )</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">P&L (CNY)</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">è°ƒæ•´å P&L</th>
                            <th class="p-3 text-center text-xs font-medium uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="session-data-body" class="divide-y divide-gray-800">
                        <tr id="session-placeholder"><td colspan="7" class="p-4 text-center text-gray-400">è¯·æ·»åŠ ç©å®¶æ•°æ®...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Summary and Actions -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mt-4 p-4 rounded-lg bg-gray-800/50">
                <div class="text-sm">
                    <p>æ€»ä¹°å…¥ç­¹ç : <span id="total-buy-in" class="font-bold">0</span></p>
                    <p>æ€»å‰©ä½™ç­¹ç : <span id="total-final-chips" class="font-bold">0</span></p>
                    <p>ç­¹ç å·®é¢ (åº”ä¸º0): <span id="chip-discrepancy" class="font-bold">0</span></p>
                    <p>CNY ç›ˆäºæ€»å’Œ (åº”ä¸º0): <span id="cny-discrepancy" class="font-bold text-yellow-400">0 CNY</span></p>
                </div>
                <div class="mt-4 sm:mt-0 flex space-x-3">
                    <button onclick="calculateSettlement()" class="btn-primary p-3 rounded-lg font-semibold bg-gray-600 hover:bg-gray-700">è®¡ç®—è½¬è´¦æ–¹æ¡ˆ</button>
                    <button onclick="saveSessionData()" id="save-session-btn" class="btn-primary p-3 rounded-lg font-semibold bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>ä¿å­˜ç‰Œå±€</button>
                    <button onclick="clearSession()" id="clear-session-btn" class="p-3 rounded-lg font-semibold bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>æ¸…ç©º</button>
                </div>
            </div>
            
            <!-- Transfer Solution -->
            <div id="transfer-solution" class="mt-6 p-4 rounded-lg bg-green-900/30 border border-green-600 hidden">
                <h3 class="text-lg font-semibold mb-2" style="color: #48bb78;">ğŸ’¸ æœ€ä½³è½¬è´¦æ–¹æ¡ˆ (æœ€å°åŒ–æ¬¡æ•°)</h3>
                <ul id="transfer-list" class="space-y-1"></ul>
            </div>
        </div>
        
        <!-- Past Sessions List (Public) -->
        <div class="card p-6 rounded-xl mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">ğŸ“œ å†å²ç‰Œå±€è®°å½• <span class="badge badge-admin">å…¬å…±æ•°æ®</span></h2>
            <div class="flex justify-between items-center mb-4">
                <p class="text-sm text-gray-400">ç‚¹å‡»åˆ é™¤æŒ‰é’®å°†ä»å…¬å…±ç§¯åˆ†æ¦œä¸­æ°¸ä¹…ç§»é™¤è¯¥ç‰Œå±€æ•°æ®ã€‚</p>
                <button onclick="loadPastSessions()" class="p-2 rounded-lg font-semibold text-sm bg-gray-600 hover:bg-gray-700">åˆ·æ–°è®°å½•</button>
            </div>
            <div id="past-sessions-list" class="space-y-3">
                <p class="text-center text-gray-500" id="sessions-loading-status">æ­£åœ¨åŠ è½½å…¬å…±å†å²è®°å½•...</p>
            </div>
        </div>

        <!-- My Private Sessions List (NEW) -->
        <div class="card p-6 rounded-xl mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">ğŸ”’ æˆ‘çš„ç§äººç‰Œå±€è®°å½• <span class="badge badge-private">ç§äººæ•°æ®</span></h2>
            <div class="flex justify-between items-center mb-4">
                <p class="text-sm text-gray-400">ç§äººæ•°æ®ä»…å¯¹å½“å‰ç™»å½•ç”¨æˆ·å¯è§ï¼Œä¸å½±å“å…¬å…±ç§¯åˆ†æ¦œã€‚</p>
                <button onclick="loadPrivateSessions()" class="p-2 rounded-lg font-semibold text-sm bg-gray-600 hover:bg-gray-700">åˆ·æ–°æˆ‘çš„è®°å½•</button>
            </div>
            <div id="private-sessions-list" class="space-y-3">
                <p class="text-center text-gray-500" id="private-sessions-loading-status">ç™»å½•åå¯æŸ¥çœ‹å’Œç¼–è¾‘æ‚¨çš„ç§äººç‰Œå±€ã€‚</p>
            </div>
        </div>

        <!-- Leaderboard (Scoreboard) (Public) -->
        <div class="card p-6 rounded-xl mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">ğŸ“Š æ€»ç§¯åˆ†æ¦œ <span class="badge badge-admin">å…¬å…± Leaderboard</span></h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700 rounded-lg overflow-hidden">
                    <thead class="table-header">
                        <tr>
                            <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">ç©å®¶</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">æ€»ç›ˆäº (CNY)</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">å¹³å‡ç›ˆäº</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">èƒœç‡ (%)</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">æ³¢åŠ¨ç‡ (CNY)</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">Sharpe Ratio</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">æœ€å¤§è¿äº (æ¬¡æ•°)</th>
                            <th class="p-3 text-center text-xs font-medium uppercase tracking-wider">æ€»å±€æ•°</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body" class="divide-y divide-gray-800">
                        <tr id="leaderboard-placeholder"><td colspan="8" class="p-4 text-center text-gray-400">åŠ è½½ä¸­... è¯·ç¡®ä¿å·²ä¿å­˜å…¬å…±ç‰Œå±€æ•°æ®ã€‚</td></tr>
                    </tbody>
                </table>
            </div>
            <button onclick="loadPublicScoreboard()" class="btn-primary mt-4 p-2 rounded-lg font-semibold bg-gray-600 hover:bg-gray-700">åˆ·æ–°å…¬å…±ç§¯åˆ†æ¦œ</button>
        </div>
        
        <!-- My Private Leaderboard (NEW) -->
        <div class="card p-6 rounded-xl">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">ğŸ‘¤ æˆ‘çš„ç§äººç§¯åˆ†æ¦œ <span class="badge badge-private">ç§äºº Leaderboard</span></h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700 rounded-lg overflow-hidden">
                    <thead class="table-header">
                        <tr>
                            <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">ç©å®¶</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">æ€»ç›ˆäº (CNY)</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">å¹³å‡ç›ˆäº</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">èƒœç‡ (%)</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">æ³¢åŠ¨ç‡ (CNY)</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">Sharpe Ratio</th>
                            <th class="p-3 text-right text-xs font-medium uppercase tracking-wider">æœ€å¤§è¿äº (æ¬¡æ•°)</th>
                            <th class="p-3 text-center text-xs font-medium uppercase tracking-wider">æ€»å±€æ•°</th>
                        </tr>
                    </thead>
                    <tbody id="private-leaderboard-body" class="divide-y divide-gray-800">
                        <tr id="private-leaderboard-placeholder"><td colspan="8" class="p-4 text-center text-gray-400">ç™»å½•åå¯æŸ¥çœ‹æ‚¨çš„ç§äººç§¯åˆ†æ¦œã€‚</td></tr>
                    </tbody>
                </table>
            </div>
            <button onclick="loadPrivateScoreboard()" class="btn-primary mt-4 p-2 rounded-lg font-semibold bg-gray-600 hover:bg-gray-700">åˆ·æ–°ç§äººç§¯åˆ†æ¦œ</button>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, getDoc, deleteDoc, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Authorization Configuration ---
        // âš ï¸ å…³é”®æ­¥éª¤ 1: è¯·å°†æ­¤é‚®ç®±æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„ Google è´¦æˆ·é‚®ç®±ï¼Œè¯¥è´¦æˆ·å°†æ‹¥æœ‰ç¼–è¾‘å…¬å…±æ•°æ®çš„æƒé™
        // ğŸš¨ğŸš¨ğŸš¨ å¦‚æœæ­¤å¤„ä»ä¸ºå ä½ç¬¦ï¼Œç®¡ç†å‘˜æƒé™å°†ä¸ä¼šå¯ç”¨ï¼Œæ‚¨å°†æ— æ³•åˆ é™¤å…¬å…±æ•°æ®ï¼ğŸš¨ğŸš¨ğŸš¨
        const ADMIN_EMAIL = 'xirry.xyz@gmail.com'; 
        let isAdmin = false; 

        // Global variables for Firebase services
        let db;
        let auth;
        let userId = 'anonymous'; // Default user ID

        // Session Data (Config is now local and per-session)
        let sessionPlayers = [];

        // --- Firebase Configuration ---
        // âš ï¸ å…³é”®æ­¥éª¤ 2: è¿™æ˜¯æ‚¨æä¾›çš„é…ç½®ã€‚è¯·ç”¨æ‚¨åœ¨ Firebase æ§åˆ¶å°è·å–çš„å®Œæ•´ã€æ­£ç¡®çš„ API å¯†é’¥æ›¿æ¢ 'REPLACE_WITH_YOUR_API_KEY'
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "***REMOVED***", // <-- è¯·æ›¿æ¢æ­¤å¤„çš„ API å¯†é’¥
            authDomain: "de1de-calculator.firebaseapp.com",
            projectId: "de1de-calculator",
            storageBucket: "de1de-calculator.firebasestorage.app",
            messagingSenderId: "1076456073032",
            appId: "1:1076456073032:web:5402bb2cb74e6940bf757d"
        };
        
        // App ID (MANDATORY)
        // åœ¨ Canvas ç¯å¢ƒä¸­ï¼Œä½¿ç”¨ __app_idï¼›å¦åˆ™ï¼Œä½¿ç”¨ Firebase project ID ä½œä¸ºé»˜è®¤ App ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : MANUAL_FIREBASE_CONFIG.projectId;

        // ä¼˜å…ˆæ£€æŸ¥ Canvas æ³¨å…¥çš„é…ç½® (__firebase_config)ï¼Œå¦åˆ™ä½¿ç”¨æ‰‹åŠ¨é…ç½® (MANUAL_FIREBASE_CONFIG)
        const firebaseConfig = 
            typeof __firebase_config !== 'undefined' && __firebase_config.length > 0
            ? JSON.parse(__firebase_config) 
            : MANUAL_FIREBASE_CONFIG;
        
        // --- End of Configuration ---


        // Expose global functions to the window object
        window.addPlayerToSession = addPlayerToSession;
        window.removePlayer = removePlayer;
        window.calculateSettlement = calculateSettlement;
        window.saveSessionData = saveSessionData;
        window.clearSession = clearSession;
        window.calculateTransfers = calculateTransfers; 
        window.deleteSession = deleteSession;
        window.signInWithGoogle = signInWithGoogle;
        window.signOutUser = signOutUser;
        // New window functions for private/public data loading
        window.loadPublicScoreboard = () => loadScoreboard(true);
        window.loadPrivateScoreboard = () => loadScoreboard(false);
        window.loadPastSessions = () => loadSessions(true);
        window.loadPrivateSessions = () => loadSessions(false);
        window.loadScoreboard = window.loadPublicScoreboard; // Keep original for default calls


        // --- Core Functions ---

        /**
         * è·å–å½“å‰ç‰Œå±€é…ç½®
         */
        function getCurrentSessionConfig() {
            const chips = parseFloat(document.getElementById('chipsPerEntry').value);
            const cny = parseFloat(document.getElementById('cnyPerEntry').value);
            
            if (isNaN(chips) || chips <= 0 || isNaN(cny) || cny <= 0) {
                 // Fallback to defaults or validation fail
                 return null;
            }
            
            return { chipsPerEntry: chips, cnyPerEntry: cny };
        }

        /**
         * è·å–å…¬å…± Firestore é›†åˆå¼•ç”¨ (Admin read/write, Others read)
         */
        function getPublicCollection(collectionName) {
            // Firestore Security Rules path: /artifacts/{appId}/public/data/{your_collection_name}
            return collection(db, `artifacts/${appId}/public/data/${collectionName}`);
        }
        
        /**
         * è·å–ç§äºº Firestore é›†åˆå¼•ç”¨ (Authenticated user read/write)
         */
        function getPrivateCollection(collectionName) {
            // Requires userId to be set
            if (userId === 'anonymous' || !db) {
                console.error("Cannot access private collection: User is anonymous or DB not initialized.");
                return null; 
            }
            // Firestore Security Rules path: /artifacts/{appId}/users/{userId}/{your_collection_name}
            return collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
        }

        /**
         * åˆ‡æ¢ç¼–è¾‘ç•Œé¢çš„å¯ç”¨/ç¦ç”¨çŠ¶æ€
         * @param {boolean} isLoggedIn - ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
         */
        function toggleEditingUI(isLoggedIn) {
            // Session input and config are now for ANY logged-in user
            const sessionInputElements = [
                'playerName', 'playerEntries', 'playerFinalChips', 'add-player-btn', 
                'chipsPerEntry', 'cnyPerEntry'
            ];
            
            sessionInputElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.disabled = !isLoggedIn;
            });
            
            // Session actions are for ANY logged-in user
            const sessionActionElements = ['save-session-btn', 'clear-session-btn'];
            sessionActionElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.disabled = !isLoggedIn;
                    if (el.tagName === 'BUTTON') {
                        el.classList.toggle('opacity-50', !isLoggedIn);
                        el.classList.toggle('cursor-not-allowed', !isLoggedIn);
                    }
                }
            });

            // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°ç§»é™¤æŒ‰é’®çš„çŠ¶æ€
            updateSessionSummary();
        }

        /**
         * Google ç™»å½•
         */
        async function signInWithGoogle() {
            if (!auth) return;
            const provider = new GoogleAuthProvider();
            try {
                provider.setCustomParameters({ prompt: 'select_account' });
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                let errorMessage = `Google ç™»å½•å‡ºé”™: ${error.message}`;
                if (error.code === 'auth/api-key-not-valid') {
                     errorMessage = `API å¯†é’¥æ— æ•ˆã€‚è¯·æ£€æŸ¥ index.html æ–‡ä»¶ä¸­çš„ 'apiKey' é…ç½®æ˜¯å¦å®Œæ•´ä¸”æ­£ç¡®ã€‚`;
                }
                alertModal("ç™»å½•å¤±è´¥", errorMessage);
            }
        }

        /**
         * é€€å‡ºç™»å½•
         */
        async function signOutUser() {
            if (!auth) return;
            try {
                await signOut(auth);
                alertModal("æ“ä½œæˆåŠŸ", "æ‚¨å·²æˆåŠŸé€€å‡ºç™»å½•ã€‚");
            } catch (error) {
                console.error("Sign Out failed:", error);
                alertModal("æ“ä½œå¤±è´¥", `é€€å‡ºç™»å½•å‡ºé”™: ${error.message}`);
            }
        }


        /**
         * åˆå§‹åŒ–Firebaseå’Œè®¤è¯
         */
        async function initializeFirebase() {
            // æ£€æŸ¥ API å¯†é’¥æ˜¯å¦å·²æ›¿æ¢
            if (firebaseConfig.apiKey === 'REPLACE_WITH_YOUR_API_KEY') {
                document.getElementById('auth-status').textContent = 'é”™è¯¯: è¯·åœ¨ä»£ç ä¸­æ›¿æ¢ API å¯†é’¥åå†éƒ¨ç½²ã€‚';
                document.getElementById('auth-button').disabled = true;
                return;
            }

            if (!firebaseConfig || !firebaseConfig.projectId) {
                console.error("Firebase config is missing or incomplete.");
                document.getElementById('auth-status').textContent = 'é”™è¯¯: Firebaseé…ç½®ç¼ºå¤±æˆ–æ— æ•ˆã€‚è¯·åœ¨ä»£ç ä¸­æ£€æŸ¥é…ç½®ã€‚';
                return;
            }
            try {
                // setLogLevel('Debug'); // For debugging in console
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
                onAuthStateChanged(auth, (user) => {
                    const authButton = document.getElementById('auth-button');
                    const authStatus = document.getElementById('auth-status');
                    const adminStatus = document.getElementById('admin-status');
                    const userIdDisplay = document.getElementById('user-id-display');
                    
                    const isLoggedIn = !!user;
                    let currentIsAdmin = false;

                    if (isLoggedIn) {
                        userId = user.uid;
                        currentIsAdmin = (user.email === ADMIN_EMAIL);
                        
                        authStatus.textContent = `å½“å‰ç”¨æˆ·: ${user.email || user.uid}`;
                        userIdDisplay.textContent = userId;
                        authButton.textContent = 'é€€å‡ºç™»å½•';
                        authButton.onclick = signOutUser;
                        authButton.disabled = false;
                        authButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        authButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
                        
                        // æ£€æŸ¥ ADMIN_EMAIL æ˜¯å¦å·²é…ç½®ï¼Œå¹¶è®¾ç½® isAdmin çŠ¶æ€
                        if (ADMIN_EMAIL === 'YOUR_ADMIN_EMAIL@gmail.com') {
                            isAdmin = false;
                            adminStatus.textContent = 'âš ï¸ è­¦å‘Š: ADMIN_EMAIL å°šæœªé…ç½®ã€‚ç®¡ç†å‘˜æƒé™å·²ç¦ç”¨ã€‚';
                            adminStatus.classList.remove('text-green-400', 'text-yellow-400');
                            adminStatus.classList.add('text-red-400');
                        } else {
                            isAdmin = currentIsAdmin;
                            if (isAdmin) {
                                adminStatus.textContent = 'ğŸ‘‘ æ‚¨æ˜¯ç®¡ç†å‘˜ï¼Œæ‹¥æœ‰å…¬å…±æ•°æ®ç¼–è¾‘å’Œåˆ é™¤æƒé™ã€‚';
                                adminStatus.classList.remove('text-yellow-400', 'text-red-400');
                                adminStatus.classList.add('text-green-400');
                            } else {
                                adminStatus.textContent = 'ğŸ”’ æ‚¨æ˜¯æ™®é€šç”¨æˆ·ï¼Œåªèƒ½ç¼–è¾‘å’ŒæŸ¥çœ‹æ‚¨çš„ç§äººç‰Œå±€ã€‚';
                                adminStatus.classList.add('text-yellow-400');
                                adminStatus.classList.remove('text-green-400', 'text-red-400');
                            }
                        }

                        // åŠ è½½æ•°æ®å¹¶åˆ‡æ¢UI
                        loadScoreboard(true); 
                        loadSessions(true); 
                        loadScoreboard(false); // Load private scoreboard
                        loadSessions(false); // Load private sessions
                        toggleEditingUI(isLoggedIn); 

                    } else {
                        userId = 'anonymous';
                        isAdmin = false;
                        
                        authStatus.textContent = 'æœªç™»å½•ã€‚è¯·ä½¿ç”¨ Google è´¦æˆ·ç™»å½•ã€‚';
                        
                        if (ADMIN_EMAIL === 'YOUR_ADMIN_EMAIL@gmail.com') {
                            adminStatus.textContent = 'âš ï¸ è­¦å‘Š: ADMIN_EMAIL å°šæœªé…ç½®ã€‚';
                        } else {
                            adminStatus.textContent = 'ğŸ”’ ç¼–è¾‘åŠŸèƒ½å·²é”å®šã€‚';
                        }
                        adminStatus.classList.add('text-red-400');
                        adminStatus.classList.remove('text-green-400', 'text-yellow-400');
                        userIdDisplay.textContent = 'N/A';

                        authButton.textContent = 'ä½¿ç”¨ Google ç™»å½•';
                        authButton.onclick = signInWithGoogle;
                        authButton.disabled = false;
                        authButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                        authButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');

                        // å³ä½¿æœªç™»å½•ä¹Ÿå°è¯•åŠ è½½å…¬å…±æ•°æ® (å¦‚æœå®‰å…¨è§„åˆ™å…è®¸)
                        loadScoreboard(true);
                        loadSessions(true);
                        
                        // æ¸…ç©ºç§äººæ•°æ®
                        document.getElementById('private-sessions-list').innerHTML = '<p class="text-center text-gray-500" id="private-sessions-loading-status">ç™»å½•åå¯æŸ¥çœ‹å’Œç¼–è¾‘æ‚¨çš„ç§äººç‰Œå±€ã€‚</p>';
                        document.getElementById('private-leaderboard-body').innerHTML = '<tr id="private-leaderboard-placeholder"><td colspan="8" class="p-4 text-center text-gray-400">ç™»å½•åå¯æŸ¥çœ‹æ‚¨çš„ç§äººç§¯åˆ†æ¦œã€‚</td></tr>';

                        toggleEditingUI(isLoggedIn); 
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization or Auth Failed:", error);
                document.getElementById('auth-status').textContent = 'é”™è¯¯: Firebaseåˆå§‹åŒ–å¤±è´¥ã€‚';
            }
        }
        
        /**
         * æ·»åŠ ç©å®¶åˆ°å½“å‰ç‰Œå±€
         */
        function addPlayerToSession() {
            if (userId === 'anonymous') {
                alertModal("æ“ä½œå¤±è´¥", "è¯·å…ˆç™»å½•æ‰èƒ½æ·»åŠ ç©å®¶æ•°æ®ã€‚");
                return;
            }
            
            const currentConfig = getCurrentSessionConfig();
            if (!currentConfig) {
                alertModal("è¾“å…¥é”™è¯¯", "è¯·ç¡®ä¿æ¯æ‰‹ä¹°å…¥çš„ç­¹ç æ•°å’ŒCNYéƒ½ä¸ºæœ‰æ•ˆçš„æ­£æ•°ã€‚");
                return;
            }

            const name = document.getElementById('playerName').value.trim();
            const entries = parseFloat(document.getElementById('playerEntries').value);
            const finalChips = parseFloat(document.getElementById('playerFinalChips').value);

            if (!name || isNaN(entries) || isNaN(finalChips) || finalChips < 0) {
                alertModal("è¾“å…¥é”™è¯¯", "è¯·ç¡®ä¿ç©å®¶å§“åä¸ä¸ºç©ºï¼Œå‡€ä¹°å…¥æ¬¡æ•°æ˜¯æœ‰æ•ˆçš„æ•°å­—ï¼Œä¸”æœ€ç»ˆç­¹ç ä¸ºæœ‰æ•ˆçš„éè´Ÿæ•°å­—ã€‚");
                return;
            }
            
            const totalBuyInChips = entries * currentConfig.chipsPerEntry;
            const pnlChips = finalChips - totalBuyInChips;
            const pnlCNY = pnlChips * (currentConfig.cnyPerEntry / currentConfig.chipsPerEntry);

            const existingIndex = sessionPlayers.findIndex(p => p.name === name);

            const newPlayer = {
                id: Date.now() + Math.random(), // Unique ID for table row
                name,
                entries,
                totalBuyInChips: Math.round(totalBuyInChips),
                finalChips: Math.round(finalChips),
                pnlChips: Math.round(pnlChips),
                pnlCNY: parseFloat(pnlCNY.toFixed(2)),
                adjustedPnLCNY: parseFloat(pnlCNY.toFixed(2)), // Initial value before adjustment
                sessionConfig: currentConfig // Embed config for reference
            };

            if (existingIndex !== -1) {
                sessionPlayers[existingIndex] = newPlayer;
            } else {
                sessionPlayers.push(newPlayer);
            }

            // Clear input fields for next entry
            document.getElementById('playerName').value = '';
            document.getElementById('playerEntries').value = '2';
            document.getElementById('playerFinalChips').value = '3000';

            updateSessionSummary();
        }
        
        /**
         * ç§»é™¤ç©å®¶
         */
        function removePlayer(id) {
            if (userId === 'anonymous') {
                alertModal("æ“ä½œå¤±è´¥", "è¯·å…ˆç™»å½•æ‰èƒ½ç§»é™¤ç©å®¶ã€‚");
                return;
            }
            sessionPlayers = sessionPlayers.filter(p => p.id !== id);
            updateSessionSummary();
        }

        /**
         * æ ¹æ®ç”¨æˆ·æŒ‡å®šçš„ä¼˜å…ˆçº§è°ƒæ•´ç›ˆäºä»¥æŠ¹å¹³ç­¹ç å·®é¢
         */
        function adjustDiscrepancy(players) {
            let totalPnL = players.reduce((sum, p) => sum + p.pnlCNY, 0);

            if (Math.abs(totalPnL) < 0.01) {
                return players.map(p => ({ ...p, adjustedPnLCNY: p.pnlCNY }));
            }

            const adjustedPlayers = players.map(p => ({ ...p, adjustedPnLCNY: p.pnlCNY }));
            const adjustmentMagnitude = Math.abs(totalPnL); 

            if (totalPnL > 0) { 
                const winners = adjustedPlayers.filter(p => p.adjustedPnLCNY > 0);
                const totalWinMagnitude = winners.reduce((sum, p) => sum + p.adjustedPnLCNY, 0);
                
                if (totalWinMagnitude > 0) {
                    winners.forEach(p => {
                        const ratio = p.adjustedPnLCNY / totalWinMagnitude;
                        p.adjustedPnLCNY -= adjustmentMagnitude * ratio; 
                    });
                }
            
            } else { 
                const losers = adjustedPlayers.filter(p => p.adjustedPnLCNY < 0);
                const totalLossMagnitude = losers.reduce((sum, p) => sum + Math.abs(p.adjustedPnLCNY), 0);
                
                if (totalLossMagnitude > 0) {
                    losers.forEach(p => {
                        const ratio = Math.abs(p.adjustedPnLCNY) / totalLossMagnitude;
                        p.adjustedPnLCNY += adjustmentMagnitude * ratio;
                    });
                }
            }
            
            return adjustedPlayers.map(p => ({ ...p, adjustedPnLCNY: parseFloat(p.adjustedPnLCNY.toFixed(2)) }));
        }

        /**
         * æ›´æ–°å½“å‰ç‰Œå±€çš„æ•°æ®è¡¨æ ¼å’Œæ±‡æ€»ä¿¡æ¯
         */
        function updateSessionSummary() {
            sessionPlayers = adjustDiscrepancy(sessionPlayers.map(p => ({ ...p, pnlCNY: p.pnlCNY })));

            const tbody = document.getElementById('session-data-body');
            const saveBtn = document.getElementById('save-session-btn');
            tbody.innerHTML = '';
            
            let totalBuyInChips = 0;
            let totalFinalChips = 0;
            let totalPnLCNY = 0;
            
            const isEditingEnabled = userId !== 'anonymous'; // Any logged-in user can edit session

            if (sessionPlayers.length === 0) {
                tbody.innerHTML = '<tr id="session-placeholder"><td colspan="7" class="p-4 text-center text-gray-400">è¯·æ·»åŠ ç©å®¶æ•°æ®...</td></tr>';
                saveBtn.disabled = true;
                document.getElementById('clear-session-btn').disabled = true;
            } else {
                saveBtn.disabled = !isEditingEnabled;
                document.getElementById('clear-session-btn').disabled = !isEditingEnabled;
                
                sessionPlayers.forEach(p => {
                    totalBuyInChips += p.totalBuyInChips;
                    totalFinalChips += p.finalChips;
                    totalPnLCNY += p.adjustedPnLCNY;

                    const pnlClass = p.adjustedPnLCNY > 0.01 ? 'text-win' : p.adjustedPnLCNY < -0.01 ? 'text-loss' : 'text-neutral';
                    
                    const removeBtnHtml = isEditingEnabled ? `
                        <button onclick="removePlayer(${p.id})" class="text-red-500 hover:text-red-400 text-sm font-semibold">ç§»é™¤</button>
                    ` : `
                        <span class="text-gray-600 text-sm cursor-not-allowed">é”å®š</span>
                    `;

                    const row = `
                        <tr class="hover:bg-gray-800/70 transition-colors">
                            <td class="p-3 font-semibold">${p.name}</td>
                            <td class="p-3 text-right">${p.totalBuyInChips}</td>
                            <td class="p-3 text-right">${p.finalChips}</td>
                            <td class="p-3 text-right ${pnlClass}">${p.pnlChips}</td>
                            <td class="p-3 text-right ${pnlClass}">${p.pnlCNY.toFixed(2)} CNY</td>
                            <td class="p-3 text-right ${pnlClass} font-bold">${p.adjustedPnLCNY.toFixed(2)} CNY</td>
                            <td class="p-3 text-center">${removeBtnHtml}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            document.getElementById('total-buy-in').textContent = Math.round(totalBuyInChips);
            document.getElementById('total-final-chips').textContent = Math.round(totalFinalChips);
            const chipDiscrepancy = Math.round(totalFinalChips - totalBuyInChips);
            document.getElementById('chip-discrepancy').textContent = chipDiscrepancy;
            
            const cnyDiscrepancyElement = document.getElementById('cny-discrepancy');
            cnyDiscrepancyElement.textContent = `${totalPnLCNY.toFixed(2)} CNY`;
            cnyDiscrepancyElement.className = totalPnLCNY > 0.01 ? 'font-bold text-win' : totalPnLCNY < -0.01 ? 'font-bold text-loss' : 'font-bold text-green-400';
            
            if (document.getElementById('transfer-solution').classList.contains('block')) {
                calculateTransfers(sessionPlayers.map(p => ({ name: p.name, pnl: p.adjustedPnLCNY })));
            }
        }
        
        /**
         * è®¡ç®—æœ€å°è½¬è´¦æ–¹æ¡ˆ (Schrage/Greedy Algorithm)
         */
        function calculateSettlement() {
            if (sessionPlayers.length === 0) {
                 alertModal("ç»“ç®—å¤±è´¥", "è¯·å…ˆæ·»åŠ ç©å®¶æ•°æ®ã€‚");
                return;
            }

            const adjustedPlayers = sessionPlayers.map(p => ({
                name: p.name,
                pnl: p.adjustedPnLCNY
            }));

            const transfers = calculateTransfers(adjustedPlayers);
            const transferList = document.getElementById('transfer-list');
            const solutionDiv = document.getElementById('transfer-solution');
            transferList.innerHTML = '';

            if (transfers.length === 0) {
                transferList.innerHTML = `<li class="text-green-300">ğŸ‰ æ‰€æœ‰ç©å®¶ç›ˆäºä¸ºé›¶ï¼Œæ— éœ€è½¬è´¦ï¼</li>`;
            } else {
                transfers.forEach(t => {
                    const listItem = `<li><span class="font-bold">${t.from}</span> â†’ <span class="font-bold">${t.to}</span>: <span class="text-green-300">${t.amount.toFixed(2)} CNY</span></li>`;
                    transferList.innerHTML += listItem;
                });
            }

            solutionDiv.classList.remove('hidden');
            solutionDiv.classList.add('block');
        }

        function calculateTransfers(players) {
            const transfers = [];
            
            let winners = players.filter(p => p.pnl > 0).map(p => ({ ...p, pnl: parseFloat(p.pnl.toFixed(2)) }));
            let losers = players.filter(p => p.pnl < 0).map(p => ({ ...p, pnl: parseFloat(p.pnl.toFixed(2)) }));

            winners.sort((a, b) => b.pnl - a.pnl);
            losers.sort((a, b) => a.pnl - b.pnl);

            while (winners.length > 0 && losers.length > 0) {
                const winner = winners[0];
                const loser = losers[0];

                const debt = Math.abs(loser.pnl);
                const credit = winner.pnl;

                const amount = Math.min(debt, credit);

                transfers.push({
                    from: loser.name,
                    to: winner.name,
                    amount: amount
                });

                winner.pnl -= amount;
                loser.pnl += amount; 

                if (Math.abs(winner.pnl) < 0.01) {
                    winners.shift();
                }
                if (Math.abs(loser.pnl) < 0.01) {
                    losers.shift();
                }
            }
            return transfers;
        }

        /**
         * å°†å½“å‰ç‰Œå±€æ•°æ®ä¿å­˜åˆ°Firestore (æ ¹æ®è§’è‰²å†³å®šå…¬å…±æˆ–ç§äºº)
         */
        async function saveSessionData() {
            if (userId === 'anonymous') {
                alertModal("ä¿å­˜å¤±è´¥", "è¯·å…ˆç™»å½•æ‰èƒ½ä¿å­˜ç‰Œå±€æ•°æ®ã€‚");
                return;
            }
            if (sessionPlayers.length === 0) {
                alertModal("ä¿å­˜å¤±è´¥", "å½“å‰ç‰Œå±€æ²¡æœ‰ç©å®¶æ•°æ®ã€‚");
                return;
            }
            if (!db) {
                alertModal("ä¿å­˜å¤±è´¥", "æ•°æ®åº“æœªè¿æ¥æˆ–è®¤è¯å¤±è´¥ã€‚");
                return;
            }
            
            const currentConfig = getCurrentSessionConfig();
            if (!currentConfig) {
                alertModal("ä¿å­˜å¤±è´¥", "è¯·ç¡®ä¿æœ¬å±€é…ç½® (ç­¹ç /CNY) ä¸ºæœ‰æ•ˆçš„æ­£æ•°ã€‚");
                return;
            }

            // Determine storage location based on user role
            // Public save is only if Admin and they choose to save to public
            const isSavingPublic = isAdmin;
            const sessionsCol = isSavingPublic ? getPublicCollection('sessions') : getPrivateCollection('private-sessions');
            const scoreboardCol = isSavingPublic ? getPublicCollection('scoreboard') : getPrivateCollection('private-scoreboard');
            const successMessage = isSavingPublic ? 'å…¬å…±ç‰Œå±€' : 'ç§äººç‰Œå±€';
            const loadSessionsFunc = isSavingPublic ? window.loadPastSessions : window.loadPrivateSessions;
            const loadScoreboardFunc = isSavingPublic ? window.loadPublicScoreboard : window.loadPrivateScoreboard;

            if (!sessionsCol || !scoreboardCol) {
                alertModal("ä¿å­˜å¤±è´¥", "æ— æ³•è·å–å­˜å‚¨è·¯å¾„ï¼Œè¯·æ£€æŸ¥ç™»å½•çŠ¶æ€ã€‚");
                return;
            }

            const sessionId = Date.now().toString(); // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ID
            const sessionData = {
                id: sessionId, 
                date: new Date().toISOString(),
                config: currentConfig, // Save current session's config
                playerResults: sessionPlayers.map(p => ({
                    name: p.name,
                    pnlCNY: p.adjustedPnLCNY,
                    isWin: p.adjustedPnLCNY > 0.01
                }))
            };

            const sessionRef = doc(sessionsCol, sessionId);
            try {
                await setDoc(sessionRef, sessionData);
            } catch (e) {
                console.error(`Error saving ${successMessage} data:`, e);
                alertModal("ä¿å­˜å¤±è´¥", `ä¿å­˜${successMessage}æ•°æ®æ—¶å‡ºé”™: ${e.message}`);
                return;
            }

            try {
                 await runTransaction(db, async (transaction) => {
                    const updates = new Map(); 

                    for (const player of sessionPlayers) {
                        // The scoreboard (public or private) tracks player history
                        const playerRef = doc(scoreboardCol, player.name);
                        
                        const docSnapshot = await transaction.get(playerRef); 
                        
                        const newHistoryEntry = { sessionId: sessionId, date: sessionData.date, pnl: player.adjustedPnLCNY };
                        let history = [];

                        if (docSnapshot.exists()) {
                            const data = docSnapshot.data();
                            if (data.history && Array.isArray(data.history)) {
                                history = data.history.filter(h => h.sessionId !== sessionId); // ç¡®ä¿æ²¡æœ‰é‡å¤è®°å½•
                            }
                        }
                        
                        history.push(newHistoryEntry);
                        
                        updates.set(player.name, {
                            ref: playerRef,
                            data: {
                                name: player.name,
                                history: history,
                            }
                        });
                    }
                    
                    for (const update of updates.values()) {
                        transaction.set(update.ref, update.data, { merge: true });
                    }
                });

                alertModal("ä¿å­˜æˆåŠŸ", `${successMessage}å·²æˆåŠŸä¿å­˜å¹¶æ›´æ–°ç§¯åˆ†æ¦œæ•°æ®ã€‚`);
                clearSession();
                loadScoreboardFunc();
                loadSessionsFunc();

            } catch (e) {
                console.error(`Error updating ${successMessage} scoreboard in transaction:`, e);
                alertModal("ä¿å­˜å¤±è´¥", `æ›´æ–°${successMessage}ç§¯åˆ†æ¦œæ—¶å‡ºé”™ (äº‹åŠ¡å¤±è´¥): ${e.message}`);
            }
        }

        /**
         * æ¸…ç©ºå½“å‰ç‰Œå±€æ•°æ®
         */
        function clearSession() {
            if (userId === 'anonymous') {
                alertModal("æ“ä½œå¤±è´¥", "è¯·å…ˆç™»å½•æ‰èƒ½æ¸…ç©ºç‰Œå±€ã€‚");
                return;
            }
            sessionPlayers = [];
            document.getElementById('transfer-solution').classList.remove('block');
            document.getElementById('transfer-solution').classList.add('hidden');
            updateSessionSummary();
        }

        // --- Session Management ---

        /**
         * åŠ è½½å¹¶æ˜¾ç¤ºå†å²ç‰Œå±€
         * @param {boolean} isPublic - æ˜¯å¦åŠ è½½å…¬å…±ç‰Œå±€ (true) è¿˜æ˜¯ç§äººç‰Œå±€ (false)
         */
        async function loadSessions(isPublic = true) {
            const sessionsCol = isPublic ? getPublicCollection('sessions') : getPrivateCollection('private-sessions');
            const listId = isPublic ? 'past-sessions-list' : 'private-sessions-list';
            const statusId = isPublic ? 'sessions-loading-status' : 'private-sessions-loading-status';
            const sessionType = isPublic ? 'å…¬å…±' : 'ç§äºº';
            
            const sessionListDiv = document.getElementById(listId);
            if (!sessionListDiv) return;

            sessionListDiv.innerHTML = `<p class="text-center text-gray-500" id="${statusId}">æ­£åœ¨åŠ è½½${sessionType}è®°å½•...</p>`;
            
            if (!db) {
                document.getElementById(statusId).textContent = `æ•°æ®åº“æœªè¿æ¥ã€‚è¯·ç¨å€™æˆ–ç™»å½•ã€‚`;
                return;
            }
            if (!isPublic && userId === 'anonymous') {
                document.getElementById(statusId).textContent = `è¯·ç™»å½•ä»¥åŠ è½½æ‚¨çš„ç§äººæ•°æ®ã€‚`;
                return;
            }
            if (!sessionsCol && !isPublic) {
                 document.getElementById(statusId).textContent = `æ— æ³•è·å–ç§äººå­˜å‚¨è·¯å¾„ã€‚`;
                return;
            }


            try {
                const snapshot = await getDocs(sessionsCol);
                const sessions = [];
                snapshot.forEach(doc => {
                    sessions.push({ id: doc.id, ...doc.data() });
                });

                sessions.sort((a, b) => new Date(b.date) - new Date(a.date));

                sessionListDiv.innerHTML = ''; // Clear status message

                if (sessions.length === 0) {
                    sessionListDiv.innerHTML = `<p class="text-center text-gray-500">æš‚æ— å·²ä¿å­˜çš„${sessionType}ç‰Œå±€è®°å½•ã€‚</p>`;
                } else {
                    sessions.forEach(session => {
                        const date = new Date(session.date).toLocaleString('zh-CN', {
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit'
                        });
                        
                        const playerSummary = session.playerResults.map(p => {
                            const pnlClass = p.pnlCNY > 0.01 ? 'text-win' : p.pnlCNY < -0.01 ? 'text-loss' : 'text-neutral';
                            return `<span class="text-sm font-medium ${pnlClass}">${p.name} (${p.pnlCNY.toFixed(2)})</span>`;
                        }).join(', ');
                        
                        // Delete logic: Admin can delete Public (isPublic=true), Logged-in user can delete Private (isPublic=false)
                        // ä½¿ç”¨å…¨å±€ isAdmin å˜é‡è¿›è¡Œæ£€æŸ¥
                        const canDelete = (isPublic && isAdmin) || (!isPublic && userId !== 'anonymous');
                        
                        const deleteBtn = canDelete ? `
                            <button onclick="deleteSession('${session.id}', ${JSON.stringify(session.playerResults).replace(/'/g, "\\'")}, ${isPublic})" 
                                class="p-2 rounded-lg font-semibold text-sm bg-red-700 hover:bg-red-800 w-full sm:w-auto flex-shrink-0">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>` : `
                            <span class="p-2 rounded-lg font-semibold text-sm bg-gray-600 text-gray-400 w-full sm:w-auto flex-shrink-0 text-center cursor-not-allowed">
                                ğŸ”’ é”å®š
                            </span>`;
                        
                        const configInfo = session.config ? 
                            `<span class="text-xs text-gray-500">é…ç½®: ${session.config.chipsPerEntry} ç­¹ç  = ${session.config.cnyPerEntry} CNY</span>` : '';


                        const sessionElement = document.createElement('div');
                        sessionElement.className = 'card p-4 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-2 sm:space-y-0';
                        sessionElement.innerHTML = `
                            <div class="flex flex-col w-full sm:w-3/4">
                                <span class="text-base font-semibold text-white">ç‰Œå±€æ—¶é—´: ${date}</span>
                                <span class="text-sm text-gray-400 mt-1">æ€»ç»“: ${playerSummary}</span>
                                ${configInfo}
                            </div>
                            ${deleteBtn}
                        `;
                        sessionListDiv.appendChild(sessionElement);
                    });
                }
            } catch (e) {
                if (e.code === 'permission-denied') {
                    console.warn(`[CONSOLE_WARN] Error loading ${sessionType} sessions (Permission Denied). Check Firestore rules.`);
                    sessionListDiv.innerHTML = `<p class="text-center text-gray-500">${sessionType}è®°å½•åŠ è½½å¤±è´¥ (åªè¯»æ¨¡å¼)ã€‚</p>`;
                } else {
                    console.error(`Error loading ${sessionType} sessions:`, e);
                    sessionListDiv.innerHTML = `<p class="text-center text-red-400">åŠ è½½${sessionType}è®°å½•å¤±è´¥: ${e.message}</p>`;
                }
            }
        }

        /**
         * åˆ é™¤æŒ‡å®šçš„ç‰Œå±€è®°å½•å¹¶æ›´æ–°æ‰€æœ‰å—å½±å“çš„ç§¯åˆ†æ¦œ
         * @param {string} sessionId - ç‰Œå±€ID
         * @param {Array<Object>} playerResults - ç‰Œå±€ç»“æœ
         * @param {boolean} isPublic - æ˜¯å¦ä¸ºå…¬å…±ç‰Œå±€
         */
        async function deleteSession(sessionId, playerResults, isPublic = true) {
            const sessionType = isPublic ? 'å…¬å…±' : 'ç§äºº';
            
            // å†æ¬¡æ£€æŸ¥æƒé™
            if (isPublic && !isAdmin) {
                alertModal("æ“ä½œå¤±è´¥", "åªæœ‰ç®¡ç†å‘˜æ‰èƒ½åˆ é™¤å…¬å…±ç‰Œå±€ã€‚");
                return;
            }
            if (!isPublic && userId === 'anonymous') {
                 alertModal("æ“ä½œå¤±è´¥", "è¯·å…ˆç™»å½•æ‰èƒ½åˆ é™¤ç§äººç‰Œå±€ã€‚");
                return;
            }
            if (!db) {
                alertModal("æ“ä½œå¤±è´¥", "æ•°æ®åº“æœªè¿æ¥ã€‚");
                return;
            }
            
            const sessionsCol = isPublic ? getPublicCollection('sessions') : getPrivateCollection('private-sessions');
            const scoreboardCol = isPublic ? getPublicCollection('scoreboard') : getPrivateCollection('private-scoreboard');

            if (!sessionsCol || !scoreboardCol) {
                alertModal("æ“ä½œå¤±è´¥", "æ— æ³•è·å–å­˜å‚¨è·¯å¾„ï¼Œè¯·æ£€æŸ¥ç™»å½•çŠ¶æ€ã€‚");
                return;
            }
            
            const loadSessionsFunc = isPublic ? window.loadPastSessions : window.loadPrivateSessions;
            const loadScoreboardFunc = isPublic ? window.loadPublicScoreboard : window.loadPrivateScoreboard;

            // Custom modal confirmation
            const confirmAction = await new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="card p-6 rounded-xl w-full max-w-md">
                        <h3 class="text-xl font-bold mb-3 text-red-500">ç¡®è®¤åˆ é™¤</h3>
                        <p class="text-gray-300 mb-4">ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ‰‹${sessionType}ç‰Œå±€ (ID: ${sessionId}) å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚</p>
                        <div class="flex justify-end space-x-3">
                            <button id="modal-cancel-btn" class="p-3 rounded-lg font-semibold bg-gray-600 hover:bg-gray-700">å–æ¶ˆ</button>
                            <button id="modal-delete-btn" class="p-3 rounded-lg font-semibold bg-red-600 hover:bg-red-700">æ°¸ä¹…åˆ é™¤</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('modal-cancel-btn').onclick = () => { document.body.removeChild(modal); resolve(false); };
                document.getElementById('modal-delete-btn').onclick = () => { document.body.removeChild(modal); resolve(true); };
            });

            if (!confirmAction) {
                return;
            }
            
            const sessionRef = doc(sessionsCol, sessionId);

            try {
                await runTransaction(db, async (transaction) => {
                    const scoreboardUpdates = new Map(); 

                    for (const result of playerResults) {
                        const playerRef = doc(scoreboardCol, result.name);
                        const docSnapshot = await transaction.get(playerRef);

                        if (docSnapshot.exists()) {
                            const data = docSnapshot.data();
                            let history = data.history || [];

                            const updatedHistory = history.filter(h => h.sessionId !== sessionId);
                            
                            scoreboardUpdates.set(result.name, {
                                ref: playerRef,
                                data: {
                                    name: result.name,
                                    history: updatedHistory,
                                }
                            });
                        }
                    }

                    for (const update of scoreboardUpdates.values()) {
                        transaction.set(update.ref, update.data, { merge: true });
                    }
                    
                    transaction.delete(sessionRef);
                });

                alertModal("åˆ é™¤æˆåŠŸ", `${sessionType}ç‰Œå±€ ${sessionId} å·²æˆåŠŸåˆ é™¤å¹¶æ›´æ–°äº†ç§¯åˆ†æ¦œã€‚`);
                
                loadScoreboardFunc();
                loadSessionsFunc();

            } catch (e) {
                console.error(`Error deleting ${sessionType} session in transaction:`, e);
                alertModal("åˆ é™¤å¤±è´¥", `åˆ é™¤${sessionType}ç‰Œå±€å’Œæ›´æ–°ç§¯åˆ†æ¦œæ—¶å‡ºé”™: ${e.message}`);
            }
        }


        // --- Scoreboard / Metrics Calculation ---

        /**
         * ä»FirestoreåŠ è½½å¹¶è®¡ç®—ç§¯åˆ†æ¦œ
         * @param {boolean} isPublic - æ˜¯å¦åŠ è½½å…¬å…±ç§¯åˆ†æ¦œ (true) è¿˜æ˜¯ç§äººç§¯åˆ†æ¦œ (false)
         */
        async function loadScoreboard(isPublic = true) {
            const scoreboardCol = isPublic ? getPublicCollection('scoreboard') : getPrivateCollection('private-scoreboard');
            const tbodyId = isPublic ? 'leaderboard-body' : 'private-leaderboard-body';
            const placeholderId = isPublic ? 'leaderboard-placeholder' : 'private-leaderboard-placeholder';
            const scoreboardType = isPublic ? 'å…¬å…±' : 'ç§äºº';
            
            const tbody = document.getElementById(tbodyId);
            const placeholder = document.getElementById(placeholderId);
            
            if (!tbody || !placeholder) return;
            
            if (!db) {
                placeholder.textContent = `æ•°æ®åº“æœªè¿æ¥ã€‚è¯·ç¨å€™æˆ–ç™»å½•ã€‚`;
                return;
            }
            if (!isPublic && userId === 'anonymous') {
                placeholder.textContent = `è¯·ç™»å½•ä»¥åŠ è½½æ‚¨çš„ç§äººç§¯åˆ†æ¦œã€‚`;
                return;
            }
            if (!scoreboardCol && !isPublic) {
                 placeholder.textContent = `æ— æ³•è·å–ç§äººå­˜å‚¨è·¯å¾„ã€‚`;
                return;
            }

            placeholder.textContent = `æ­£åœ¨ä»äº‘ç«¯åŠ è½½${scoreboardType}æ•°æ®...`;
            
            try {
                const snapshot = await getDocs(scoreboardCol);
                const playerStatsMap = new Map();

                const allHistory = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.history && Array.isArray(data.history)) {
                        data.history.forEach(h => {
                             allHistory.push({ name: data.name, ...h });
                        });
                    }
                });

                const groupedHistory = allHistory.reduce((acc, item) => {
                    if (!acc[item.name]) acc[item.name] = [];
                    acc[item.name].push(item);
                    return acc;
                }, {});
                
                for (const name in groupedHistory) {
                    const history = groupedHistory[name].sort((a, b) => new Date(a.date) - new Date(b.date));
                    playerStatsMap.set(name, calculateMetrics(name, history));
                }

                renderLeaderboard([...playerStatsMap.values()], isPublic);
                
            } catch (e) {
                if (e.code === 'permission-denied') {
                    console.warn(`[CONSOLE_WARN] Error loading ${scoreboardType} scoreboard (Permission Denied). Check Firestore rules.`);
                    placeholder.textContent = `${scoreboardType}ç§¯åˆ†æ¦œæ•°æ®åŠ è½½å¤±è´¥ (åªè¯»æ¨¡å¼)ã€‚`;
                } else {
                    console.error(`Error loading ${scoreboardType} scoreboard:`, e);
                    placeholder.textContent = `åŠ è½½${scoreboardType}ç§¯åˆ†æ¦œå¤±è´¥: ${e.message}`;
                }
            }
        }

        /**
         * è®¡ç®—å•ä¸ªç©å®¶çš„å…¨éƒ¨æŒ‡æ ‡
         */
        function calculateMetrics(name, history) {
            const pnls = history.map(h => h.pnl);
            const totalSessions = pnls.length;
            if (totalSessions === 0) {
                return { name, totalSessions: 0, totalPnL: 0, avgPnL: 0, winRate: 0, volatility: 0, sharpe: 0, maxLosingStreak: 0 };
            }

            const totalPnL = pnls.reduce((sum, pnl) => sum + pnl, 0);
            const avgPnL = totalPnL / totalSessions;

            const variance = pnls.reduce((sum, pnl) => sum + Math.pow(pnl - avgPnL, 2), 0) / totalSessions;
            const volatility = Math.sqrt(variance);

            // Sharpe = (Avg PnL - Risk Free Rate) / Volatility. Assume Risk Free Rate = 0
            const sharpe = volatility > 0 ? avgPnL / volatility : (avgPnL > 0 ? Infinity : 0);

            const sessionsWon = pnls.filter(pnl => pnl > 0.01).length;
            const winRate = (sessionsWon / totalSessions) * 100;

            // æœ€å¤§è¿äºæ¬¡æ•°
            let currentLosingStreak = 0;
            let maxLosingStreak = 0;

            for (const pnl of pnls) {
                if (pnl < -0.01) { 
                    currentLosingStreak++;
                } else {
                    currentLosingStreak = 0; 
                }
                maxLosingStreak = Math.max(maxLosingStreak, currentLosingStreak);
            }


            return {
                name,
                totalSessions,
                totalPnL: totalPnL,
                avgPnL: avgPnL,
                winRate: winRate,
                volatility: volatility,
                sharpe: sharpe,
                maxLosingStreak: maxLosingStreak
            };
        }

        /**
         * æ¸²æŸ“ç§¯åˆ†æ¦œè¡¨æ ¼
         * @param {Array<Object>} stats - ç©å®¶ç»Ÿè®¡æ•°æ®
         * @param {boolean} isPublic - æ˜¯å¦æ¸²æŸ“å…¬å…±ç§¯åˆ†æ¦œ (true) è¿˜æ˜¯ç§äººç§¯åˆ†æ¦œ (false)
         */
        function renderLeaderboard(stats, isPublic = true) {
            const tbodyId = isPublic ? 'leaderboard-body' : 'private-leaderboard-body';
            const placeholderId = isPublic ? 'leaderboard-placeholder' : 'private-leaderboard-placeholder';
            const tbody = document.getElementById(tbodyId);
            
            if (!tbody) return;
            
            if (stats.length === 0) {
                const scoreboardType = isPublic ? 'å…¬å…±' : 'ç§äºº';
                tbody.innerHTML = `<tr id="${placeholderId}"><td colspan="8" class="p-4 text-center text-gray-400">æš‚æ— ${scoreboardType}æ•°æ®ã€‚è¯·ä¿å­˜ä¸€æ¬¡ç‰Œå±€ã€‚</td></tr>`;
                return;
            }

            stats.sort((a, b) => b.totalPnL - a.totalPnL);

            tbody.innerHTML = '';

            stats.forEach(s => {
                const pnlClass = s.totalPnL > 0.01 ? 'text-win' : s.totalPnL < -0.01 ? 'text-loss' : 'text-neutral';
                let sharpeText = isFinite(s.sharpe) ? s.sharpe.toFixed(2) : 'N/A';
                let sharpeClass = s.sharpe > 0.5 ? 'text-win' : s.sharpe > 0 ? 'text-yellow-400' : 'text-neutral';
                
                if (s.sharpe === Infinity) {
                    sharpeText = 'âˆ';
                    sharpeClass = 'text-green-400';
                }
                
                const row = `
                    <tr class="hover:bg-gray-800/70 transition-colors">
                        <td class="p-3 font-semibold">${s.name}</td>
                        <td class="p-3 text-right ${pnlClass} font-bold">${s.totalPnL.toFixed(2)}</td>
                        <td class="p-3 text-right">${s.avgPnL.toFixed(2)}</td>
                        <td class="p-3 text-right">${s.winRate.toFixed(1)}%</td>
                        <td class="p-3 text-right">${s.volatility.toFixed(2)}</td>
                        <td class="p-3 text-right ${sharpeClass}">${sharpeText}</td>
                        <td class="p-3 text-right text-loss font-bold">${s.maxLosingStreak}</td>
                        <td class="p-3 text-center">${s.totalSessions}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        // --- Utility ---

        function alertModal(title, message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="card p-6 rounded-xl w-full max-w-md">
                    <h3 class="text-xl font-bold mb-3 text-white">${title}</h3>
                    <p class="text-gray-300 mb-4">${message}</p>
                    <button id="modal-ok-btn" class="btn-primary w-full p-3 rounded-lg font-semibold bg-blue-600 hover:bg-blue-700">ç¡®å®š</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('modal-ok-btn').onclick = () => document.body.removeChild(modal);
        }
        
        // Initial setup on window load
        window.onload = initializeFirebase;

    </script>
</body>
</html>