<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>de1de tracker</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // é…ç½® Tailwind çš„æš—é»‘æ¨¡å¼ç­–ç•¥ä¸º class
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* å®šä¹‰ CSS å˜é‡ä»¥æ”¯æŒä¸»é¢˜åˆ‡æ¢ */
        :root {
            /* Light Theme Default */
            --bg-body: #F9FAFB;
            --text-main: #111827;
            --text-muted: #6B7280;
            --bg-card: #FFFFFF;
            --border-card: #E5E7EB;
            --bg-subtle: #F9FAFB; /* è¡¨å¤´ã€èƒŒæ™¯å¡«å…… */
            --border-subtle: #F3F4F6;
            --input-bg: #FFFFFF;
            --input-border: #D1D5DB;
            
            --btn-primary-bg: #111827;
            --btn-primary-text: #FFFFFF;
            --btn-sec-bg: #FFFFFF;
            --btn-sec-border: #D1D5DB;
            --btn-sec-text: #374151;
        }

        /* Dark Theme Overrides (æ¢å¤éƒ¨åˆ†ä¹‹å‰çš„æå®¢æš—è‰²è°ƒ) */
        html.dark {
            --bg-body: #0d1117;
            --text-main: #e6edf3;
            --text-muted: #8b949e;
            --bg-card: #161b22;
            --border-card: #30363d;
            --bg-subtle: #21262d; 
            --border-subtle: #30363d;
            --input-bg: #0d1117;
            --input-border: #30363d;

            --btn-primary-bg: #238636; /* GitHub Green for primary action in dark */
            --btn-primary-text: #ffffff;
            --btn-sec-bg: #21262d;
            --btn-sec-border: #30363d;
            --btn-sec-text: #c9d1d9;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
        }

        .text-main { color: var(--text-main); }
        .text-muted { color: var(--text-muted); }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-card);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        /* Utility for sections inside cards */
        .bg-subtle { background-color: var(--bg-subtle); }
        .border-subtle { border-color: var(--border-subtle); }

        .btn-primary {
            background-color: var(--btn-primary-bg);
            color: var(--btn-primary-text);
            transition: all 0.2s;
        }
        .btn-primary:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: var(--btn-sec-bg);
            border: 1px solid var(--btn-sec-border);
            color: var(--btn-sec-text);
            transition: all 0.2s;
        }
        .btn-secondary:hover:not(:disabled) {
            filter: brightness(0.95);
        }

        .input-field {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-main);
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s;
        }
        .input-field:disabled {
            background-color: var(--bg-subtle);
            color: var(--text-muted);
            cursor: not-allowed;
            border-color: var(--border-card);
        }
        .input-field:focus {
            outline: none;
            border-color: var(--text-main);
            box-shadow: 0 0 0 1px var(--text-main);
        }
        
        /* Dark mode specific focus adjustment */
        html.dark .input-field:focus {
            border-color: #58a6ff;
            box-shadow: 0 0 0 1px #58a6ff;
        }

        .table-header {
            background-color: var(--bg-subtle);
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-subtle);
        }
        
        /* Badges */
        .text-win { color: #059669; } 
        .bg-win-sub { background-color: #D1FAE5; color: #065F46; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
        
        html.dark .text-win { color: #3fb950; }
        html.dark .bg-win-sub { background-color: rgba(46, 160, 67, 0.15); color: #3fb950; }

        .text-loss { color: #DC2626; } 
        .bg-loss-sub { background-color: #FEE2E2; color: #991B1B; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
        
        html.dark .text-loss { color: #f85149; }
        html.dark .bg-loss-sub { background-color: rgba(248, 81, 73, 0.15); color: #f85149; }
        
        .text-neutral { color: var(--text-muted); }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.025em;
        }
        .badge-admin { background-color: #FEF3C7; color: #92400E; }
        html.dark .badge-admin { background-color: rgba(210, 153, 34, 0.15); color: #d29922; }
        
        .badge-private { background-color: #E0E7FF; color: #3730A3; }
        html.dark .badge-private { background-color: rgba(88, 166, 255, 0.15); color: #58a6ff; }
        
        /* Sortable Header Styles */
        th.sortable { cursor: pointer; user-select: none; transition: background-color 0.2s; }
        th.sortable:hover { background-color: rgba(0,0,0,0.05); }
        html.dark th.sortable:hover { background-color: rgba(255,255,255,0.05); }
        th.sortable .sort-icon { margin-left: 4px; font-size: 0.8em; color: var(--text-muted); }
        th.sortable.active-sort { color: var(--text-main); }
        
        /* Theme Toggle Button */
        .theme-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            color: var(--text-muted);
            transition: background-color 0.2s, color 0.2s;
        }
        .theme-toggle:hover {
            background-color: var(--bg-subtle);
            color: var(--text-main);
        }
    </style>
    <script>
        // Init Theme immediately to prevent flash
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const sysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && sysDark)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
</head>
<body class="antialiased">

    <div class="min-h-screen p-4 sm:p-8 max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-bold text-main tracking-tight">de1de tracker</h1>
                <p class="text-muted mt-1 text-sm">å¾·å·æ‰‘å…‹ç‰Œå±€è¿½è¸ªä¸æ•°æ®åˆ†æ</p>
            </div>
            
            <div class="flex items-center space-x-4 mt-4 md:mt-0">
                <!-- Theme Toggle -->
                <button onclick="toggleTheme()" class="theme-toggle" title="åˆ‡æ¢äº®è‰²/æš—è‰²æ¨¡å¼">
                    <!-- Sun Icon (Show in Dark Mode) -->
                    <svg id="icon-sun" class="w-5 h-5 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <!-- Moon Icon (Show in Light Mode) -->
                    <svg id="icon-moon" class="w-5 h-5 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>

                <div class="text-right hidden sm:block">
                    <p id="auth-status" class="text-sm font-medium text-main">æ­£åœ¨åˆå§‹åŒ–...</p>
                    <p id="admin-status" class="text-xs text-muted"></p>
                </div>
                <button id="auth-button" class="btn-primary py-2 px-5 rounded-lg text-sm font-medium shadow-sm opacity-50 cursor-not-allowed" disabled>
                    åŠ è½½ä¸­...
                </button>
            </div>
        </div>
        
        <!-- Mobile Auth Status -->
        <div class="sm:hidden mb-6 p-3 bg-subtle rounded-lg border border-subtle shadow-sm">
            <p class="text-xs text-muted uppercase font-semibold mb-1">Status</p>
            <p id="auth-status-mobile" class="text-sm font-medium text-main">...</p>
            <p class="text-xs text-muted mt-1">ID: <span id="user-id-display" class="font-mono">...</span></p>
        </div>

        <!-- Session Configuration -->
        <div class="card rounded-xl mb-8 overflow-hidden">
            <div class="px-6 py-4 border-b border-subtle bg-subtle">
                <h2 class="text-lg font-bold text-main">æœ¬å±€é…ç½®ä¸å½•å…¥</h2>
            </div>
            
            <div class="p-6">
                <!-- Session Meta -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="sessionName" class="block text-sm font-medium text-muted mb-1.5">ç‰Œå±€åç§° (é€‰å¡«)</label>
                        <input type="text" id="sessionName" class="input-field w-full p-2.5 rounded-lg" placeholder="ä¾‹å¦‚: å‘¨äº”å…»ç”Ÿå±€">
                    </div>
                    <div>
                        <label for="sessionDate" class="block text-sm font-medium text-muted mb-1.5">ç‰Œå±€æ—¥æœŸ</label>
                        <input type="date" id="sessionDate" class="input-field w-full p-2.5 rounded-lg">
                    </div>
                </div>

                <!-- Session Configuration -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8 pb-8 border-b border-subtle">
                    <div>
                        <label for="chipsPerEntry" class="block text-sm font-medium text-muted mb-1.5">æ¯æ‰‹ä¹°å…¥ç­¹ç æ•°</label>
                        <input type="number" id="chipsPerEntry" value="3000" class="input-field w-full p-2.5 rounded-lg" placeholder="3000">
                    </div>
                    <div>
                        <label for="cnyPerEntry" class="block text-sm font-medium text-muted mb-1.5">æ¯æ‰‹ä¹°å…¥å¯¹åº” CNY</label>
                        <input type="number" id="cnyPerEntry" value="300" class="input-field w-full p-2.5 rounded-lg" placeholder="300">
                    </div>
                </div>

                <!-- Player Input -->
                <div class="bg-subtle rounded-lg p-5 border border-subtle">
                    <p class="text-xs font-semibold text-muted uppercase mb-3">æ·»åŠ ç©å®¶æ•°æ®</p>
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                        <div>
                            <input type="text" id="playerName" class="input-field w-full p-2.5 rounded-lg" placeholder="ç©å®¶å§“å" disabled>
                        </div>
                        <div>
                            <input type="number" id="playerEntries" value="2" class="input-field w-full p-2.5 rounded-lg" placeholder="å‡€ä¹°å…¥æ¬¡æ•°" disabled>
                            <p class="text-xs text-muted mt-1">ä¾‹å¦‚: 2 æˆ– -1</p>
                        </div>
                        <div>
                            <input type="number" id="playerFinalChips" value="3000" class="input-field w-full p-2.5 rounded-lg" placeholder="æœ€ç»ˆç­¹ç " disabled>
                        </div>
                        <div>
                            <button onclick="addPlayerToSession()" id="add-player-btn" class="btn-primary w-full p-2.5 rounded-lg font-semibold shadow-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                + æ·»åŠ ç©å®¶
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Results -->
        <div class="card rounded-xl mb-8 overflow-hidden">
            <div class="px-6 py-4 border-b border-subtle bg-subtle flex justify-between items-center">
                <h2 class="text-lg font-bold text-main">å½“å‰ç»“ç®—é¢„è§ˆ</h2>
                <div class="text-sm text-muted font-medium">
                    å·®é¢: <span id="cny-discrepancy" class="font-bold text-main">0 CNY</span>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-subtle">
                    <thead class="table-header">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">ç©å®¶</th>
                            <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">æ€»ä¹°å…¥ (ç­¹ç )</th>
                            <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">æœ€ç»ˆç­¹ç </th>
                            <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">P&L (ç­¹ç )</th>
                            <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">P&L (CNY)</th>
                            <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">è°ƒæ•´å P&L</th>
                            <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="session-data-body" class="bg-card divide-y divide-subtle">
                        <tr id="session-placeholder"><td colspan="7" class="px-6 py-10 text-center text-muted italic">æš‚æ— æ•°æ®ï¼Œè¯·åœ¨ä¸Šæ–¹æ·»åŠ ç©å®¶...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Footer -->
            <div class="bg-subtle px-6 py-4 border-t border-subtle flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                <div class="text-xs text-muted space-x-4">
                    <span>æ€»ä¹°å…¥: <span id="total-buy-in" class="font-bold text-main">0</span></span>
                    <span>æ€»å‰©ä½™: <span id="total-final-chips" class="font-bold text-main">0</span></span>
                    <span>åå·®: <span id="chip-discrepancy" class="font-bold text-main">0</span></span>
                </div>
                <div class="flex space-x-3">
                    <button onclick="calculateSettlement()" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium shadow-sm">è®¡ç®—è½¬è´¦</button>
                    <button onclick="clearSession()" id="clear-session-btn" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 disabled:opacity-50" disabled>æ¸…ç©º</button>
                    <button onclick="saveSessionData()" id="save-session-btn" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium shadow-sm disabled:opacity-50" disabled>ä¿å­˜ç‰Œå±€</button>
                </div>
            </div>
            
            <!-- Transfer Solution -->
            <div id="transfer-solution" class="hidden border-t border-subtle bg-emerald-50/50 dark:bg-emerald-900/10 p-6">
                <h3 class="text-sm font-bold text-emerald-800 dark:text-emerald-400 uppercase mb-3 flex items-center">
                    æœ€ä½³è½¬è´¦æ–¹æ¡ˆ
                </h3>
                <ul id="transfer-list" class="space-y-2 text-sm text-emerald-900 dark:text-emerald-300"></ul>
            </div>
        </div>
        
        <!-- Grid for Lists -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Public List -->
            <div class="card rounded-xl overflow-hidden h-96 flex flex-col">
                <div class="px-6 py-4 border-b border-subtle bg-subtle flex justify-between items-center sticky top-0">
                    <div>
                        <h2 class="text-lg font-bold text-main">ğŸ“œ å†å²ç‰Œå±€</h2>
                        <span class="badge badge-admin mt-1">å…¬å…±æ•°æ®</span>
                    </div>
                    <button onclick="loadPastSessions()" class="text-muted hover:text-main transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </button>
                </div>
                <div id="past-sessions-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-subtle/50">
                    <p class="text-center text-muted text-sm mt-10" id="sessions-loading-status">åŠ è½½ä¸­...</p>
                </div>
            </div>

            <!-- Private List -->
            <div class="card rounded-xl overflow-hidden h-96 flex flex-col">
                <div class="px-6 py-4 border-b border-subtle bg-subtle flex justify-between items-center sticky top-0">
                    <div>
                        <h2 class="text-lg font-bold text-main">ğŸ”’ æˆ‘çš„è®°å½•</h2>
                        <span class="badge badge-private mt-1">ç§äººæ•°æ®</span>
                    </div>
                    <button onclick="loadPrivateSessions()" class="text-muted hover:text-main transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </button>
                </div>
                <div id="private-sessions-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-subtle/50">
                    <p class="text-center text-muted text-sm mt-10" id="private-sessions-loading-status">ç™»å½•åæŸ¥çœ‹...</p>
                </div>
            </div>
        </div>

        <!-- Leaderboards -->
        <div class="space-y-8">
            <!-- Public Scoreboard -->
            <div class="card rounded-xl overflow-hidden">
                <div class="px-6 py-5 border-b border-subtle bg-card flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div>
                        <h2 class="text-xl font-bold text-main">æ€»ç§¯åˆ†æ¦œ</h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="badge badge-admin">å…¬å…±</span>
                            <span class="text-xs text-muted">ç‚¹å‡»è¡¨å¤´æ’åº</span>
                        </div>
                    </div>
                    <button onclick="loadPublicScoreboard()" class="btn-secondary px-3 py-1.5 rounded-lg text-xs font-medium mt-3 sm:mt-0">åˆ·æ–°åˆ—è¡¨</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-subtle">
                        <thead class="table-header">
                            <tr id="public-leaderboard-header">
                                <!-- Headers -->
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body" class="bg-card divide-y divide-subtle">
                            <tr id="leaderboard-placeholder"><td colspan="9" class="px-6 py-10 text-center text-muted">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Private Scoreboard -->
            <div class="card rounded-xl overflow-hidden">
                <div class="px-6 py-5 border-b border-subtle bg-card flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div>
                        <h2 class="text-xl font-bold text-main">ç§äººç§¯åˆ†æ¦œ</h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="badge badge-private">ç§äºº</span>
                            <span class="text-xs text-muted">ç‚¹å‡»è¡¨å¤´æ’åº</span>
                        </div>
                    </div>
                    <button onclick="loadPrivateScoreboard()" class="btn-secondary px-3 py-1.5 rounded-lg text-xs font-medium mt-3 sm:mt-0">åˆ·æ–°åˆ—è¡¨</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-subtle">
                        <thead class="table-header">
                            <tr id="private-leaderboard-header">
                                <!-- Headers -->
                            </tr>
                        </thead>
                        <tbody id="private-leaderboard-body" class="bg-card divide-y divide-subtle">
                            <tr id="private-leaderboard-placeholder"><td colspan="9" class="px-6 py-10 text-center text-muted">è¯·ç™»å½•ä»¥æŸ¥çœ‹ç§äººæ•°æ®ã€‚</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, getDoc, deleteDoc, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global functions for UI
        window.toggleTheme = function() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        };

        const ADMIN_EMAIL = 'xirry.xyz@gmail.com'; 
        let isAdmin = false; 
        let db; let auth; let userId = 'anonymous'; 
        let sessionPlayers = [];
        let publicLeaderboardData = []; let privateLeaderboardData = [];
        let sortState = { public: { column: 'score', direction: 'desc' }, private: { column: 'score', direction: 'desc' } };

        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "***REMOVED***", 
            authDomain: "de1de-calculator.firebaseapp.com",
            projectId: "de1de-calculator",
            storageBucket: "de1de-calculator.firebasestorage.app",
            messagingSenderId: "1076456073032",
            appId: "1:1076456073032:web:5402bb2cb74e6940bf757d"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : MANUAL_FIREBASE_CONFIG.projectId;
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config.length > 0 ? JSON.parse(__firebase_config) : MANUAL_FIREBASE_CONFIG;
        
        window.addPlayerToSession = addPlayerToSession;
        window.removePlayer = removePlayer;
        window.calculateSettlement = calculateSettlement;
        window.saveSessionData = saveSessionData;
        window.clearSession = clearSession;
        window.calculateTransfers = calculateTransfers; 
        window.deleteSession = deleteSession;
        window.signInWithGoogle = signInWithGoogle;
        window.signOutUser = signOutUser;
        window.loadPublicScoreboard = () => loadScoreboard(true);
        window.loadPrivateScoreboard = () => loadScoreboard(false);
        window.loadPastSessions = () => loadSessions(true);
        window.loadPrivateSessions = () => loadSessions(false);
        window.toggleSort = toggleSort;

        function getCurrentSessionConfig() {
            const chips = parseFloat(document.getElementById('chipsPerEntry').value);
            const cny = parseFloat(document.getElementById('cnyPerEntry').value);
            if (isNaN(chips) || chips <= 0 || isNaN(cny) || cny <= 0) return null;
            return { chipsPerEntry: chips, cnyPerEntry: cny };
        }
        function getPublicCollection(collectionName) { return collection(db, `artifacts/${appId}/public/data/${collectionName}`); }
        function getPrivateCollection(collectionName) { if (userId === 'anonymous' || !db) return null; return collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`); }

        function toggleEditingUI(canEdit) {
            const sessionInputElements = ['playerName', 'playerEntries', 'playerFinalChips', 'add-player-btn', 'chipsPerEntry', 'cnyPerEntry', 'sessionName', 'sessionDate'];
            sessionInputElements.forEach(id => { const el = document.getElementById(id); if (el) el.disabled = !canEdit; });
            const sessionActionElements = ['save-session-btn', 'clear-session-btn'];
            sessionActionElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.disabled = !canEdit;
                    if (el.tagName === 'BUTTON') {
                        el.classList.toggle('opacity-50', !canEdit);
                        el.classList.toggle('cursor-not-allowed', !canEdit);
                    }
                }
            });
            updateSessionSummary();
        }

        async function signInWithGoogle() {
            if (!auth) return;
            const provider = new GoogleAuthProvider();
            try {
                provider.setCustomParameters({ prompt: 'select_account' });
                await signInWithPopup(auth, provider);
            } catch (error) {
                alertModal("ç™»å½•å¤±è´¥", error.message);
            }
        }

        async function signOutUser() {
            if (!auth) return;
            try { await signOut(auth); alertModal("æ“ä½œæˆåŠŸ", "æ‚¨å·²æˆåŠŸé€€å‡ºç™»å½•ã€‚"); } catch (error) { alertModal("æ“ä½œå¤±è´¥", error.message); }
        }

        async function initializeFirebase() {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            document.getElementById('sessionDate').value = `${yyyy}-${mm}-${dd}`;

            if (firebaseConfig.apiKey === 'REPLACE_WITH_YOUR_API_KEY') { document.getElementById('auth-status').textContent = 'é”™è¯¯: è¯·é…ç½® API Key'; return; }
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try { await signInWithCustomToken(auth, __initial_auth_token); } catch (e) { console.error("Custom token error", e); }
                }

                onAuthStateChanged(auth, (user) => {
                    const authButton = document.getElementById('auth-button');
                    const authStatus = document.getElementById('auth-status');
                    const authStatusMobile = document.getElementById('auth-status-mobile'); 
                    const adminStatus = document.getElementById('admin-status');
                    const userIdDisplay = document.getElementById('user-id-display');
                    
                    authButton.disabled = false;
                    authButton.classList.remove('opacity-50', 'cursor-not-allowed');

                    if (user) {
                        userId = user.uid;
                        const isAnon = user.isAnonymous;
                        const email = user.email;
                        isAdmin = (!isAnon && email === ADMIN_EMAIL);

                        userIdDisplay.textContent = userId.substring(0, 8) + '...';
                        
                        if (isAnon) {
                            const statusText = 'è®¿å®¢æ¨¡å¼';
                            authStatus.textContent = statusText;
                            if(authStatusMobile) authStatusMobile.textContent = statusText;
                            adminStatus.textContent = 'ç™»å½•ä»¥ç¼–è¾‘';
                            
                            authButton.textContent = 'Google ç™»å½•';
                            authButton.onclick = signInWithGoogle;
                            
                            loadScoreboard(true); loadSessions(true);
                            toggleEditingUI(false);
                        } else {
                            const statusText = email;
                            authStatus.textContent = statusText;
                            if(authStatusMobile) authStatusMobile.textContent = statusText;
                            adminStatus.textContent = isAdmin ? 'ç®¡ç†å‘˜æƒé™' : 'æ™®é€šç”¨æˆ·';

                            authButton.textContent = 'é€€å‡º';
                            authButton.onclick = signOutUser;
                            
                            loadScoreboard(true); loadSessions(true); loadScoreboard(false); loadSessions(false);
                            toggleEditingUI(true); 
                        }
                    } else {
                        userId = 'anonymous';
                        isAdmin = false;
                        const statusText = 'æœªç™»å½•';
                        authStatus.textContent = statusText;
                        if(authStatusMobile) authStatusMobile.textContent = statusText;
                        adminStatus.textContent = 'è®¿å®¢æ¨¡å¼';
                        userIdDisplay.textContent = '...';
                        
                        authButton.textContent = 'Google ç™»å½•';
                        authButton.onclick = signInWithGoogle;
                        
                        loadScoreboard(true); loadSessions(true);
                        toggleEditingUI(false);
                    }
                });
            } catch (error) {
                console.error("Init Error", error);
                document.getElementById('auth-status').textContent = 'Error';
            }
        }
        
        function addPlayerToSession() {
            if (!auth.currentUser || auth.currentUser.isAnonymous) { alertModal("é™åˆ¶", "è¯·å…ˆç™»å½•"); return; }
            const currentConfig = getCurrentSessionConfig();
            if (!currentConfig) { alertModal("é”™è¯¯", "é…ç½®æ— æ•ˆ"); return; }
            const name = document.getElementById('playerName').value.trim();
            const entries = parseFloat(document.getElementById('playerEntries').value);
            const finalChips = parseFloat(document.getElementById('playerFinalChips').value);
            if (!name || isNaN(entries) || isNaN(finalChips) || finalChips < 0) { alertModal("é”™è¯¯", "æ£€æŸ¥è¾“å…¥"); return; }
            
            const totalBuyInChips = entries * currentConfig.chipsPerEntry;
            const pnlChips = finalChips - totalBuyInChips;
            const pnlCNY = pnlChips * (currentConfig.cnyPerEntry / currentConfig.chipsPerEntry);

            const existingIndex = sessionPlayers.findIndex(p => p.name === name);
            const newPlayer = {
                id: Date.now() + Math.random(),
                name, entries,
                totalBuyInChips: Math.round(totalBuyInChips),
                finalChips: Math.round(finalChips),
                pnlChips: Math.round(pnlChips),
                pnlCNY: parseFloat(pnlCNY.toFixed(2)),
                adjustedPnLCNY: parseFloat(pnlCNY.toFixed(2)),
                sessionConfig: currentConfig
            };
            if (existingIndex !== -1) sessionPlayers[existingIndex] = newPlayer; else sessionPlayers.push(newPlayer);
            document.getElementById('playerName').value = '';
            document.getElementById('playerEntries').value = '2';
            document.getElementById('playerFinalChips').value = '3000';
            updateSessionSummary();
        }
        
        function removePlayer(id) { if (!auth.currentUser || auth.currentUser.isAnonymous) return; sessionPlayers = sessionPlayers.filter(p => p.id !== id); updateSessionSummary(); }
        function adjustDiscrepancy(players) {
            let totalPnL = players.reduce((sum, p) => sum + p.pnlCNY, 0);
            if (Math.abs(totalPnL) < 0.01) return players.map(p => ({ ...p, adjustedPnLCNY: p.pnlCNY }));
            const adjustedPlayers = players.map(p => ({ ...p, adjustedPnLCNY: p.pnlCNY }));
            const adjustmentMagnitude = Math.abs(totalPnL); 
            if (totalPnL > 0) { 
                const winners = adjustedPlayers.filter(p => p.adjustedPnLCNY > 0);
                const totalWinMagnitude = winners.reduce((sum, p) => sum + p.adjustedPnLCNY, 0);
                if (totalWinMagnitude > 0) winners.forEach(p => { p.adjustedPnLCNY -= adjustmentMagnitude * (p.adjustedPnLCNY / totalWinMagnitude); });
            } else { 
                const losers = adjustedPlayers.filter(p => p.adjustedPnLCNY < 0);
                const totalLossMagnitude = losers.reduce((sum, p) => sum + Math.abs(p.adjustedPnLCNY), 0);
                if (totalLossMagnitude > 0) losers.forEach(p => { p.adjustedPnLCNY += adjustmentMagnitude * (Math.abs(p.adjustedPnLCNY) / totalLossMagnitude); });
            }
            return adjustedPlayers.map(p => ({ ...p, adjustedPnLCNY: parseFloat(p.adjustedPnLCNY.toFixed(2)) }));
        }

        function updateSessionSummary() {
            sessionPlayers = adjustDiscrepancy(sessionPlayers.map(p => ({ ...p, pnlCNY: p.pnlCNY })));
            const tbody = document.getElementById('session-data-body');
            const saveBtn = document.getElementById('save-session-btn');
            tbody.innerHTML = '';
            let totalBuyInChips = 0, totalFinalChips = 0, totalPnLCNY = 0;
            const isEditingEnabled = auth && auth.currentUser && !auth.currentUser.isAnonymous;

            if (sessionPlayers.length === 0) {
                tbody.innerHTML = '<tr id="session-placeholder"><td colspan="7" class="px-6 py-10 text-center text-muted italic">æš‚æ— æ•°æ®ï¼Œè¯·åœ¨ä¸Šæ–¹æ·»åŠ ç©å®¶...</td></tr>';
                saveBtn.disabled = true; document.getElementById('clear-session-btn').disabled = true;
            } else {
                saveBtn.disabled = !isEditingEnabled; document.getElementById('clear-session-btn').disabled = !isEditingEnabled;
                sessionPlayers.forEach(p => {
                    totalBuyInChips += p.totalBuyInChips; totalFinalChips += p.finalChips; totalPnLCNY += p.adjustedPnLCNY;
                    const pnlClass = p.adjustedPnLCNY > 0.01 ? 'text-win font-bold' : p.adjustedPnLCNY < -0.01 ? 'text-loss font-bold' : 'text-neutral';
                    const bgClass = p.adjustedPnLCNY > 0.01 ? 'bg-green-50 dark:bg-green-900/10' : p.adjustedPnLCNY < -0.01 ? 'bg-red-50 dark:bg-red-900/10' : '';
                    
                    const removeBtnHtml = isEditingEnabled ? `<button onclick="removePlayer(${p.id})" class="text-red-500 hover:text-red-700 dark:hover:text-red-400 text-xs font-semibold uppercase tracking-wide">åˆ é™¤</button>` : `<span class="text-gray-300 dark:text-gray-600 text-xs cursor-not-allowed">é”å®š</span>`;
                    tbody.innerHTML += `
                        <tr class="hover:bg-subtle transition-colors ${bgClass}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-main">${p.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-muted font-mono">${p.totalBuyInChips}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-muted font-mono">${p.finalChips}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right ${pnlClass} font-mono">${p.pnlChips}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right ${pnlClass} font-mono">${p.pnlCNY.toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right ${pnlClass} font-mono bg-opacity-10">${p.adjustedPnLCNY.toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">${removeBtnHtml}</td>
                        </tr>`;
                });
            }
            document.getElementById('total-buy-in').textContent = Math.round(totalBuyInChips);
            document.getElementById('total-final-chips').textContent = Math.round(totalFinalChips);
            document.getElementById('chip-discrepancy').textContent = Math.round(totalFinalChips - totalBuyInChips);
            const cnyDisElement = document.getElementById('cny-discrepancy');
            cnyDisElement.textContent = `${totalPnLCNY.toFixed(2)} CNY`;
            cnyDisElement.className = totalPnLCNY > 0.01 ? 'font-bold text-win' : totalPnLCNY < -0.01 ? 'font-bold text-loss' : 'font-bold text-main';
            if (document.getElementById('transfer-solution').classList.contains('block')) calculateSettlement();
        }
        
        function calculateSettlement() {
            if (sessionPlayers.length === 0) { alertModal("æç¤º", "è¯·å…ˆæ·»åŠ æ•°æ®"); return; }
            const transfers = calculateTransfers(sessionPlayers.map(p => ({ name: p.name, pnl: p.adjustedPnLCNY })));
            const transferList = document.getElementById('transfer-list');
            const solutionDiv = document.getElementById('transfer-solution');
            transferList.innerHTML = '';
            if (transfers.length === 0) transferList.innerHTML = `<li class="text-muted">ğŸ‰ å¹³è´¦æ— éœ€è½¬è´¦</li>`;
            else transfers.forEach(t => { transferList.innerHTML += `<li><span class="font-bold text-main">${t.from}</span> <span class="text-muted mx-1">â†’</span> <span class="font-bold text-main">${t.to}</span> <span class="float-right font-mono font-bold">${t.amount.toFixed(2)}</span></li>`; });
            solutionDiv.classList.remove('hidden'); solutionDiv.classList.add('block');
        }

        function calculateTransfers(players) {
            const transfers = [];
            let winners = players.filter(p => p.pnl > 0).map(p => ({ ...p, pnl: parseFloat(p.pnl.toFixed(2)) })).sort((a, b) => b.pnl - a.pnl);
            let losers = players.filter(p => p.pnl < 0).map(p => ({ ...p, pnl: parseFloat(p.pnl.toFixed(2)) })).sort((a, b) => a.pnl - b.pnl);
            while (winners.length > 0 && losers.length > 0) {
                const winner = winners[0], loser = losers[0];
                const amount = Math.min(Math.abs(loser.pnl), winner.pnl);
                transfers.push({ from: loser.name, to: winner.name, amount: amount });
                winner.pnl -= amount; loser.pnl += amount;
                if (Math.abs(winner.pnl) < 0.01) winners.shift(); if (Math.abs(loser.pnl) < 0.01) losers.shift();
            }
            return transfers;
        }

        async function saveSessionData() {
            if (!auth.currentUser || auth.currentUser.isAnonymous) { alertModal("æç¤º", "è¯·ç™»å½•"); return; }
            if (sessionPlayers.length === 0) { alertModal("æç¤º", "æ— æ•°æ®"); return; }
            const currentConfig = getCurrentSessionConfig();
            if (!currentConfig) return;
            const sessionName = document.getElementById('sessionName').value.trim() || 'æœªå‘½åç‰Œå±€';
            const sessionDateVal = document.getElementById('sessionDate').value;
            const sessionDate = sessionDateVal ? new Date(sessionDateVal + 'T00:00:00').toISOString() : new Date().toISOString();
            const isSavingPublic = isAdmin;
            const sessionsCol = isSavingPublic ? getPublicCollection('sessions') : getPrivateCollection('private-sessions');
            const scoreboardCol = isSavingPublic ? getPublicCollection('scoreboard') : getPrivateCollection('private-scoreboard');
            const loadFunc = isSavingPublic ? () => { window.loadPublicScoreboard(); window.loadPastSessions(); } : () => { window.loadPrivateScoreboard(); window.loadPrivateSessions(); };
            if (!sessionsCol || !scoreboardCol) { alertModal("é”™è¯¯", "æ— æ³•è·å–è·¯å¾„"); return; }

            const sessionId = Date.now().toString();
            const sessionData = { id: sessionId, date: sessionDate, name: sessionName, config: currentConfig, playerResults: sessionPlayers.map(p => ({ name: p.name, pnlCNY: p.adjustedPnLCNY, isWin: p.adjustedPnLCNY > 0.01 })) };

            try {
                await setDoc(doc(sessionsCol, sessionId), sessionData);
                await runTransaction(db, async (transaction) => {
                    const updates = new Map();
                    for (const player of sessionPlayers) {
                        const playerRef = doc(scoreboardCol, player.name);
                        const docSnapshot = await transaction.get(playerRef);
                        let history = [];
                        if (docSnapshot.exists()) { const data = docSnapshot.data(); if (data.history && Array.isArray(data.history)) history = data.history.filter(h => h.sessionId !== sessionId); }
                        history.push({ sessionId: sessionId, date: sessionData.date, pnl: player.adjustedPnLCNY });
                        updates.set(player.name, { ref: playerRef, data: { name: player.name, history: history } });
                    }
                    for (const update of updates.values()) transaction.set(update.ref, update.data, { merge: true });
                });
                alertModal("æˆåŠŸ", "å·²ä¿å­˜");
                clearSession();
                document.getElementById('sessionName').value = '';
                const now = new Date(); const yyyy = now.getFullYear(); const mm = String(now.getMonth() + 1).padStart(2, '0'); const dd = String(now.getDate()).padStart(2, '0');
                document.getElementById('sessionDate').value = `${yyyy}-${mm}-${dd}`;
                loadFunc();
            } catch (e) { console.error(e); alertModal("å¤±è´¥", e.message); }
        }

        function clearSession() { if (!auth.currentUser || auth.currentUser.isAnonymous) return; sessionPlayers = []; document.getElementById('transfer-solution').classList.add('hidden'); updateSessionSummary(); }

        async function loadSessions(isPublic = true) {
            const sessionsCol = isPublic ? getPublicCollection('sessions') : getPrivateCollection('private-sessions');
            const listId = isPublic ? 'past-sessions-list' : 'private-sessions-list';
            const statusId = isPublic ? 'sessions-loading-status' : 'private-sessions-loading-status';
            const div = document.getElementById(listId);
            if (!div) return;
            if (!db || (!isPublic && (userId === 'anonymous' || (auth.currentUser && auth.currentUser.isAnonymous))) || (!sessionsCol && !isPublic)) { if (!isPublic) { document.getElementById(statusId).textContent = "æ— æ³•åŠ è½½"; return; } }
            
            try {
                const snapshot = await getDocs(sessionsCol);
                const sessions = []; snapshot.forEach(doc => sessions.push({ id: doc.id, ...doc.data() }));
                sessions.sort((a, b) => new Date(b.date) - new Date(a.date));
                div.innerHTML = sessions.length === 0 ? `<div class="text-center py-10"><p class="text-muted text-sm">æš‚æ— è®°å½•</p></div>` : '';
                
                sessions.forEach(session => {
                    const date = new Date(session.date).toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
                    const displayName = session.name || 'æœªå‘½åç‰Œå±€';
                    const summary = session.playerResults.map(p => {
                        const colorClass = p.pnlCNY > 0 ? 'text-win font-medium' : p.pnlCNY < 0 ? 'text-loss font-medium' : 'text-muted';
                        return `<span class="${colorClass} mr-2">${p.name} <span class="text-xs opacity-75">${p.pnlCNY}</span></span>`;
                    }).join('');
                    
                    const isAnon = auth.currentUser && auth.currentUser.isAnonymous;
                    const canDelete = (isPublic && isAdmin) || (!isPublic && !isAnon && userId !== 'anonymous');
                    const escaped = JSON.stringify(session.playerResults).replace(/"/g, '&quot;');
                    const deleteBtn = canDelete ? `<button onclick="deleteSession('${session.id}', '${escaped}', ${isPublic})" class="text-muted hover:text-red-600 transition-colors p-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>` : '';
                    
                    div.innerHTML += `
                        <div class="card p-4 rounded-lg border border-subtle shadow-sm hover:shadow-md transition-shadow mb-3 bg-card">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="text-sm font-bold text-main">${displayName}</h3>
                                    <p class="text-xs text-muted mt-0.5">${date}</p>
                                </div>
                                ${deleteBtn}
                            </div>
                            <div class="text-xs leading-relaxed border-t border-subtle pt-2 mt-1">${summary}</div>
                        </div>`;
                });
            } catch (e) { div.innerHTML = `<p class="text-red-500 text-sm">Error</p>`; }
        }

        async function deleteSession(sessionId, playerResultsString, isPublic = true) {
            const playerResults = JSON.parse(playerResultsString.replace(/&quot;/g, '"'));
            const isAnon = auth.currentUser && auth.currentUser.isAnonymous;
            if ((isPublic && !isAdmin) || (!isPublic && (isAnon || userId === 'anonymous'))) { alertModal("å¤±è´¥", "æ— æƒé™"); return; }
            const sessionsCol = isPublic ? getPublicCollection('sessions') : getPrivateCollection('private-sessions');
            const scoreboardCol = isPublic ? getPublicCollection('scoreboard') : getPrivateCollection('private-scoreboard');
            const sessionRef = doc(sessionsCol, sessionId);

            if (confirm(`åˆ é™¤æ­¤è®°å½•?`)) {
                try {
                    await runTransaction(db, async (transaction) => {
                        const updates = new Map();
                        for (const result of playerResults) {
                            const playerRef = doc(scoreboardCol, result.name);
                            const docSnapshot = await transaction.get(playerRef);
                            if (docSnapshot.exists()) {
                                const data = docSnapshot.data();
                                const updatedHistory = (data.history || []).filter(h => h.sessionId !== sessionId);
                                updates.set(result.name, { ref: playerRef, data: { name: result.name, history: updatedHistory } });
                            }
                        }
                        for (const update of updates.values()) transaction.set(update.ref, update.data, { merge: true });
                        transaction.delete(sessionRef);
                    });
                    (isPublic ? window.loadPublicScoreboard : window.loadPrivateScoreboard)();
                    (isPublic ? window.loadPastSessions : window.loadPrivateSessions)();
                } catch (e) { alertModal("é”™è¯¯", e.message); }
            }
        }

        async function loadScoreboard(isPublic = true) {
            const scoreboardCol = isPublic ? getPublicCollection('scoreboard') : getPrivateCollection('private-scoreboard');
            const placeholder = document.getElementById(isPublic ? 'leaderboard-placeholder' : 'private-leaderboard-placeholder');
            if (!db || (!isPublic && (userId === 'anonymous' || (auth.currentUser && auth.currentUser.isAnonymous))) || (!scoreboardCol && !isPublic)) { if (!isPublic) return; }

            try {
                const snapshot = await getDocs(scoreboardCol);
                const allHistory = []; snapshot.forEach(doc => { const data = doc.data(); if (data.history) data.history.forEach(h => allHistory.push({ name: data.name, ...h })); });
                const groupedHistory = allHistory.reduce((acc, item) => { if (!acc[item.name]) acc[item.name] = []; acc[item.name].push(item); return acc; }, {});
                let stats = []; for (const name in groupedHistory) { stats.push(calculateMetrics(name, groupedHistory[name])); }
                stats = calculateCompositeScores(stats);
                if (isPublic) publicLeaderboardData = stats; else privateLeaderboardData = stats;
                renderLeaderboard(isPublic);
            } catch (e) { console.error(e); }
        }

        function calculateCompositeScores(stats) {
            if (stats.length === 0) return [];
            const normalize = (val, min, max) => (max === min) ? 0.5 : (val - min) / (max - min);
            const metrics = { sharpe: { min: Infinity, max: -Infinity }, avgPnL: { min: Infinity, max: -Infinity }, winRate: { min: Infinity, max: -Infinity }, totalSessions: { min: Infinity, max: -Infinity }, maxLosingStreak: { min: Infinity, max: -Infinity } };
            stats.forEach(s => {
                let sVal = s.sharpe; if (!isFinite(sVal)) sVal = s.avgPnL > 0 ? 5 : -1; s.safeSharpe = sVal;
                metrics.sharpe.min = Math.min(metrics.sharpe.min, s.safeSharpe); metrics.sharpe.max = Math.max(metrics.sharpe.max, s.safeSharpe);
                metrics.avgPnL.min = Math.min(metrics.avgPnL.min, s.avgPnL); metrics.avgPnL.max = Math.max(metrics.avgPnL.max, s.avgPnL);
                metrics.winRate.min = Math.min(metrics.winRate.min, s.winRate); metrics.winRate.max = Math.max(metrics.winRate.max, s.winRate);
                metrics.totalSessions.min = Math.min(metrics.totalSessions.min, s.totalSessions); metrics.totalSessions.max = Math.max(metrics.totalSessions.max, s.totalSessions);
                metrics.maxLosingStreak.min = Math.min(metrics.maxLosingStreak.min, s.maxLosingStreak); metrics.maxLosingStreak.max = Math.max(metrics.maxLosingStreak.max, s.maxLosingStreak);
            });
            const W = { sharpe: 0.35, avgPnL: 0.25, winRate: 0.20, sessions: 0.10, losingStreak: -0.10 };
            return stats.map(s => {
                const normSharpe = normalize(s.safeSharpe, metrics.sharpe.min, metrics.sharpe.max);
                const normAvgPnL = normalize(s.avgPnL, metrics.avgPnL.min, metrics.avgPnL.max);
                const normWinRate = normalize(s.winRate, metrics.winRate.min, metrics.winRate.max);
                const normSessions = normalize(s.totalSessions, metrics.totalSessions.min, metrics.totalSessions.max);
                const normStreak = normalize(s.maxLosingStreak, metrics.maxLosingStreak.min, metrics.maxLosingStreak.max);
                let rawScore = ((normSharpe * 100 * W.sharpe) + (normAvgPnL * 100 * W.avgPnL) + (normWinRate * 100 * W.winRate) + (normSessions * 100 * W.sessions) + (normStreak * 100 * W.losingStreak));
                s.score = rawScore;
                return s;
            });
        }

        function calculateMetrics(name, history) {
            const pnls = history.map(h => h.pnl); const totalSessions = pnls.length;
            if (totalSessions === 0) return { name, totalSessions: 0, totalPnL: 0, avgPnL: 0, winRate: 0, volatility: 0, sharpe: 0, maxLosingStreak: 0, score: 0 };
            const totalPnL = pnls.reduce((sum, pnl) => sum + pnl, 0); const avgPnL = totalPnL / totalSessions;
            const variance = pnls.reduce((sum, pnl) => sum + Math.pow(pnl - avgPnL, 2), 0) / totalSessions; const volatility = Math.sqrt(variance);
            const sharpe = volatility > 0 ? avgPnL / volatility : (avgPnL > 0 ? Infinity : 0);
            const sessionsWon = pnls.filter(pnl => pnl > 0.01).length; const winRate = (sessionsWon / totalSessions) * 100;
            let currentLosingStreak = 0, maxLosingStreak = 0; for (const pnl of pnls) { if (pnl < -0.01) currentLosingStreak++; else currentLosingStreak = 0; maxLosingStreak = Math.max(maxLosingStreak, currentLosingStreak); }
            return { name, totalSessions, totalPnL, avgPnL, winRate, volatility, sharpe, maxLosingStreak };
        }

        function toggleSort(isPublicStr, column) {
            const isPublic = (isPublicStr === 'true'); const state = isPublic ? sortState.public : sortState.private;
            if (state.column === column) { state.direction = state.direction === 'asc' ? 'desc' : 'asc'; } else { state.column = column; state.direction = 'desc'; }
            renderLeaderboard(isPublic);
        }

        function renderLeaderboard(isPublic = true) {
            const stats = isPublic ? publicLeaderboardData : privateLeaderboardData; const state = isPublic ? sortState.public : sortState.private;
            const tbodyId = isPublic ? 'leaderboard-body' : 'private-leaderboard-body'; const headerRowId = isPublic ? 'public-leaderboard-header' : 'private-leaderboard-header';
            const tbody = document.getElementById(tbodyId); const headerRow = document.getElementById(headerRowId); if (!tbody || !headerRow) return;
            const columns = [ { id: 'name', label: 'ç©å®¶' }, { id: 'score', label: 'ç»¼åˆè¯„åˆ†' }, { id: 'totalPnL', label: 'æ€»ç›ˆäº' }, { id: 'avgPnL', label: 'å¹³å‡ç›ˆäº' }, { id: 'winRate', label: 'èƒœç‡' }, { id: 'volatility', label: 'æ³¢åŠ¨ç‡' }, { id: 'sharpe', label: 'Sharpe' }, { id: 'maxLosingStreak', label: 'è¿äº' }, { id: 'totalSessions', label: 'å±€æ•°' } ];
            headerRow.innerHTML = columns.map(col => {
                let sortIcon = ''; let activeClass = ''; if (state.column === col.id) { sortIcon = state.direction === 'asc' ? 'â†‘' : 'â†“'; activeClass = 'active-sort text-main'; }
                const align = col.id === 'name' ? 'text-left' : 'text-right';
                return `<th class="px-6 py-3 ${align} text-xs font-medium uppercase tracking-wider sortable ${activeClass} hover:text-main" onclick="toggleSort('${isPublic}', '${col.id}')">${col.label} <span class="sort-icon">${sortIcon}</span></th>`;
            }).join('');
            if (stats.length === 0) { tbody.innerHTML = `<tr><td colspan="9" class="px-6 py-10 text-center text-muted">æš‚æ— æ•°æ®</td></tr>`; return; }

            stats.sort((a, b) => { let valA = a[state.column]; let valB = b[state.column]; if (!isFinite(valA)) valA = valA > 0 ? Number.MAX_VALUE : -Number.MAX_VALUE; if (!isFinite(valB)) valB = valB > 0 ? Number.MAX_VALUE : -Number.MAX_VALUE; if (state.direction === 'asc') return valA > valB ? 1 : -1; else return valA < valB ? 1 : -1; });
            tbody.innerHTML = '';
            stats.forEach(s => {
                const pnlClass = s.totalPnL > 0.01 ? 'bg-win-sub' : s.totalPnL < -0.01 ? 'bg-loss-sub' : 'text-muted';
                let sharpeText = isFinite(s.sharpe) ? s.sharpe.toFixed(2) : 'N/A'; if (s.sharpe === Infinity) sharpeText = 'âˆ';
                let displayScore = Math.round(50 + s.score); if (displayScore > 99) displayScore = 99; if (displayScore < 10) displayScore = 10;
                let scoreColor = 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300'; if (displayScore >= 80) scoreColor = 'bg-purple-100 text-purple-700 font-bold dark:bg-purple-900/30 dark:text-purple-300'; else if (displayScore >= 60) scoreColor = 'bg-emerald-100 text-emerald-700 font-bold dark:bg-emerald-900/30 dark:text-emerald-300'; else if (displayScore < 40) scoreColor = 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300';

                tbody.innerHTML += `
                    <tr class="hover:bg-subtle transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-main">${s.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right"><span class="inline-block px-2.5 py-0.5 rounded-full text-xs ${scoreColor}">${displayScore}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-mono"><span class="${pnlClass}">${s.totalPnL.toFixed(0)}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-muted font-mono">${s.avgPnL.toFixed(0)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-muted font-mono">${s.winRate.toFixed(0)}%</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-muted font-mono">${s.volatility.toFixed(0)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-muted font-mono">${sharpeText}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-muted font-mono">${s.maxLosingStreak}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-muted font-mono">${s.totalSessions}</td>
                    </tr>`;
            });
        }
        function alertModal(title, message) {
            const modal = document.createElement('div'); modal.className = 'fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 transition-opacity';
            modal.innerHTML = `<div class="bg-card p-6 rounded-2xl shadow-xl w-full max-w-sm border border-subtle transform scale-100 transition-transform"><h3 class="text-lg font-bold mb-2 text-main">${title}</h3><p class="text-muted mb-6 text-sm leading-relaxed">${message}</p><button id="modal-ok-btn" class="w-full btn-primary font-medium py-2.5 rounded-lg transition-colors">ç¡®å®š</button></div>`;
            document.body.appendChild(modal); document.getElementById('modal-ok-btn').onclick = () => document.body.removeChild(modal);
        }
        window.onload = initializeFirebase;
    </script>
</body>
</html>